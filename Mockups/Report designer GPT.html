<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Report Builder — Layout Inicial</title>

  <!-- Bibliotecas solicitadas -->
  <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
  <script src="https://unpkg.com/petite-vue" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/alasql"></script>
  <script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.27/dist/interact.min.js"></script>

  <!-- Estilos modernos e responsivos -->
  <style>
    /* Reset mínimo */
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    :root{
      --bg:#0f1724;
      --panel:#0b1220;
      --card:#0f172a;
      --muted:#9aa6b2;
      --accent1:#7c3aed;
      --accent2:#06b6d4;
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
    }
    body{
      background: linear-gradient(180deg, #071025 0%, #07162a 60%);
      color:#e6eef6;
      padding:18px;
      box-sizing:border-box;
    }

    .app {
      display:grid;
      grid-template-columns: 260px 1fr 320px;
      gap:18px;
      height:calc(100vh - 36px);
    }

    /* Left panel (toolbox) */
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:16px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
      overflow:auto;
    }
    .panel h3 { margin:4px 0 12px 0; font-size:16px; color:#f8fbff; }
    .object-list { display:flex; flex-direction:column; gap:10px; }
    .obj-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:12px;
      border-radius:10px;
      cursor:grab;
      display:flex;
      align-items:center;
      gap:10px;
      transition:transform .12s ease, box-shadow .12s ease;
      border:1px solid rgba(255,255,255,0.02);
    }
    .obj-card:active{ cursor:grabbing; transform:scale(0.995); }
    .obj-icon { width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700; color:white; }
    .obj-label { font-size:14px; color:#eaf4ff; }
    .pill { font-size:12px; color:var(--muted); background:var(--glass); padding:6px 8px; border-radius:999px; }

    /* Center canvas */
    .canvas-wrap {
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .toolbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }

    .title-box{
      display:flex; align-items:center; gap:12px;
    }
    .title {
      font-size:18px; font-weight:700; letter-spacing:0.2px; color:#fff;
    }
    .toolbar .btn {
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      padding:10px 14px;
      border-radius:10px;
      color:white; border:none; cursor:pointer;
      box-shadow: 0 6px 18px rgba(124,58,237,0.18);
      font-weight:600; font-size:14px;
    }

    .canvas {
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border-radius:12px;
      padding:24px;
      min-height:0;
      overflow:auto;
      border: 1px solid rgba(255,255,255,0.03);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .report-page {
      width:100%;
      max-width:1060px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border-radius:12px;
      padding:18px;
      min-height:720px;
      box-shadow: 0 12px 40px rgba(2,6,23,0.6), 0 1px 0 rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.032);
      position:relative;
      overflow:visible;
    }

    /* Widgets placed on the page */
    .widget {
      position:absolute;
      min-width:120px;
      min-height:40px;
      border-radius:8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      box-shadow: 0 8px 30px rgba(3,8,20,0.6);
      border:1px solid rgba(255,255,255,0.03);
      padding:10px;
      color:#eaf4ff;
      overflow:hidden;
      cursor:move;
      transition:box-shadow .12s ease, transform .08s ease;
    }
    .widget .w-title { font-weight:700; font-size:13px; margin-bottom:6px; }
    .widget .w-body { font-size:12px; color:var(--muted); }

    .widget.selected {
      box-shadow: 0 18px 40px rgba(8,12,30,0.75);
      outline: 2px solid rgba(124,58,237,0.18);
      transform: translateY(-2px);
    }

    /* Right properties panel */
    .prop-title { font-size:15px; margin-bottom:8px; }
    .props { display:flex; flex-direction:column; gap:10px; }
    .prop-row { display:flex; gap:8px; align-items:center; }
    .prop-row label { width:110px; color:var(--muted); font-size:13px; }
    .prop-row input, .prop-row select, .prop-row textarea {
      flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03);
      background:var(--glass);
      color:#eaf4ff; font-size:13px;
    }

    /* Footer instructions */
    .muted { color:var(--muted); font-size:13px; }

    /* Responsive */
    @media (max-width:1100px){
      .app{ grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; height:auto; }
      .panel, .canvas-wrap, .panel-right { width:100%; }
      .canvas { order:2; }
    }
  </style>
</head>
<body>
  <div id="app" v-scope="reportBuilder()" class="app">

    <!-- LEFT: Toolbox -->
    <div class="panel">
      <h3>Componentes</h3>
      <div class="object-list">
        <div class="obj-card" data-type="table" v-on:mounted="makeSourceDraggable($el)" title="Arraste para adicionar tabela">
          <div class="obj-icon" style="background:linear-gradient(180deg,var(--accent1),#5a23c9);">T</div>
          <div>
            <div class="obj-label">Tabela</div>
            <div class="pill">Dados em grid / agrupamentos</div>
          </div>
        </div>

        <div class="obj-card" data-type="text" v-on:mounted="makeSourceDraggable($el)" title="Arraste para adicionar texto">
          <div class="obj-icon" style="background:linear-gradient(180deg,var(--accent2),#0596a8);">A</div>
          <div>
            <div class="obj-label">Texto</div>
            <div class="pill">Campo ou texto livre</div>
          </div>
        </div>

        <div class="obj-card" data-type="header" v-on:mounted="makeSourceDraggable($el)">
          <div class="obj-icon" style="background:linear-gradient(180deg,#ff6b6b,#ff4757);">H</div>
          <div>
            <div class="obj-label">Header</div>
            <div class="pill">Repetir por página</div>
          </div>
        </div>

      </div>

      <hr style="margin:14px 0; border:0; height:1px; background:rgba(255,255,255,0.02)">

      <h3>Fonte de dados (dummy)</h3>
      <div class="muted" style="margin-bottom:8px;">Datasource de exemplo: 30 faturas</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" v-on:click="loadDummy()">Carregar Dummy</button>
        <button class="btn" style="background:linear-gradient(90deg,#34d399,#10b981)" v-on:click="clearCanvas()">Limpar</button>
      </div>
      <div style="margin-top:12px;" class="muted">Datasource atual: <strong>{{state.datasource.name}}</strong></div>

    </div>

    <!-- CENTER: Canvas -->
    <div class="canvas-wrap">
      <div class="toolbar">
        <div class="title-box">
          <div class="title">Report Designer</div>
          <div style="margin-left:12px;" class="pill">Layout — Fase 1</div>
        </div>
        <div>
          <button class="btn" v-on:click="exportLayout()">Exportar</button>
        </div>
      </div>

      <div class="canvas" ref="canvas">
        <div class="report-page" ref="page" id="reportPage">
          <!-- grid background faint lines to hint columns -->
          <div v-on:mounted="initPageGrid($el)" style="position:absolute; inset:0; pointer-events:none;"></div>

          <!-- Widgets rendered dynamically -->
          <template v-for="w in state.widgets">
            <div class="widget"
                 :class="{selected: state.selected && state.selected.id==w.id}"
                 :style="widgetStyle(w)"
                 v-on:click="selectWidget(w, $event)"
                 :data-id="w.id"
                 ref="widgetElems">
              <div class="w-title">{{w.title}}</div>
              <div class="w-body">{{w.type}} — {{w.preview}}</div>
            </div>
          </template>

        </div>
      </div>
    </div>

    <!-- RIGHT: Properties -->
    <div class="panel panel-right">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div class="prop-title">Propriedades</div>
          <div class="muted">Editar propriedades do elemento seleccionado</div>
        </div>
        <div class="pill">Reativo: petite-vue</div>
      </div>

      <div style="margin-top:12px;" class="props">
        <div v-if="state.selected">
          <div class="prop-row"><label>Tipo:</label><input type="text" v-model="state.selected.type" disabled /></div>
          <div class="prop-row"><label>Título:</label><input type="text" v-model="state.selected.title" /></div>
          <div class="prop-row"><label>Conteúdo:</label><input type="text" v-model="state.selected.preview" /></div>
          <div class="prop-row"><label>X (px):</label><input type="number" v-model.number="state.selected.x" /></div>
          <div class="prop-row"><label>Y (px):</label><input type="number" v-model.number="state.selected.y" /></div>
          <div class="prop-row"><label>Largura (px):</label><input type="number" v-model.number="state.selected.w" /></div>
          <div class="prop-row"><label>Altura (px):</label><input type="number" v-model.number="state.selected.h" /></div>
          <div style="display:flex; gap:8px;">
            <button class="btn" v-on:click="bringToFront(state.selected)">Trazer para frente</button>
            <button class="btn" style="background:linear-gradient(90deg,#ef4444,#f97316)" v-on:click="deleteSelected()">Eliminar</button>
          </div>
        </div>

        <div v-if="!state.selected" class="muted">Selecione um elemento na página para ver/editar suas propriedades.</div>

      </div>

      <hr style="margin:14px 0; border:0; height:1px; background:rgba(255,255,255,0.02)">

      <div>
        <div style="font-weight:700; margin-bottom:8px;">Info rápida</div>
        <div class="muted">Drag & drop suave com interact.js. Redimensione pelos cantos. O protótipo foca no layout visual e na experiência do utilizador.</div>
      </div>

    </div>
  </div>

  <!-- Lógica JS: apenas var / function / anonymous functions -->
  <script>
    /* ---------- Model constructors (function-style classes) ---------- */
    function MReportWidget(data){
      this.id = data.id || ('w' + (new Date()).getTime() + Math.floor(Math.random()*1000));
      this.type = data.type || 'text';
      this.title = data.title || ('Elemento ' + this.type);
      this.preview = data.preview || 'Preview...';
      this.x = data.x || 40;
      this.y = data.y || 40;
      this.w = data.w || 260;
      this.h = data.h || 90;
      this.z = data.z || 1;
    }

    function MDataSource(data){
      this.name = data.name || 'dummy';
      this.rows = data.rows || [];
    }

    /* ---------- App (petite-vue) ---------- */
    function reportBuilder(){
      var state = {
        widgets: [],
        selected: null,
        datasource: new MDataSource({name:'(nenhuma)', rows:[]})
      };

      /* helper: style for widget */
      function widgetStyle(w){
        var s = {};
        s.left = w.x + 'px';
        s.top = w.y + 'px';
        s.width = w.w + 'px';
        s.height = w.h + 'px';
        s.zIndex = w.z;
        return s;
      }

      /* create dummy data */
      function loadDummy(){
        var rows = [];
        var i = 1;
        while (i <= 30){
          var r = {
            nomecliente: 'Cliente ' + i,
            nocliente: 1000 + i,
            valor: Math.round(Math.random()*10000)/100,
            data: new Date(2024, Math.floor(Math.random()*12), (i%28)+1).toISOString().slice(0,10),
            activo: (i%2==0),
            morada: 'Rua ' + i
          };
          rows.push(r);
          i++;
        }
        state.datasource = new MDataSource({name:'Dummy Faturas', rows:rows});
        return;
      }

      /* clear canvas */
      function clearCanvas(){
        state.widgets.splice(0, state.widgets.length);
        state.selected = null;
      }

      /* select widget */
      function selectWidget(w, ev){
        // prevent event bubbling selecting document
        if (!w) return;
        state.selected = w;
        // stop propagation so canvas click won't clear
        if (ev && ev.stopPropagation) ev.stopPropagation();
      }

      /* delete selected */
      function deleteSelected(){
        if (!state.selected) return;
        var id = state.selected.id;
        for (var i=0;i<state.widgets.length;i++){
          if (state.widgets[i].id==id){
            state.widgets.splice(i,1);
            break;
          }
        }
        state.selected = null;
      }

      /* bring to front */
      function bringToFront(w){
        var maxz = 1;
        for (var i=0;i<state.widgets.length;i++){
          if (state.widgets[i].z > maxz) maxz = state.widgets[i].z;
        }
        w.z = maxz + 1;
      }

      /* export layout (simple JSON) */
      function exportLayout(){
        var exportObj = {datasource:state.datasource.name, widgets:[]};
        for (var i=0;i<state.widgets.length;i++){
          var ww = state.widgets[i];
          exportObj.widgets.push({
            id: ww.id, type: ww.type, title: ww.title, preview: ww.preview,
            x: ww.x, y: ww.y, w: ww.w, h: ww.h, z: ww.z
          });
        }
        var txt = JSON.stringify(exportObj, null, 2);
        // show in new window
        var win = window.open('', '_blank');
        win.document.write('<pre style="font-family:monospace;white-space:pre-wrap;">' + txt + '</pre>');
      }

      /* Add widget to canvas given drop coordinates relative to page */
      function addWidgetFromType(type, pageRect, dropX, dropY){
        var w = new MReportWidget({ type: type });
        // center near drop
        w.x = Math.max(16, Math.round(dropX - pageRect.left));
        w.y = Math.max(16, Math.round(dropY - pageRect.top));
        // different defaults
        if (type==='table'){ w.w = 580; w.h = 220; w.title = 'Tabela'; w.preview = 'Tabela (Tabulator)'; }
        if (type==='text'){ w.w = 360; w.h = 80; w.title = 'Texto'; w.preview = 'Texto ligado a campo'; }
        if (type==='header'){ w.w = 960; w.h = 90; w.title = 'Header'; w.preview = 'Header que repete por página'; }
        state.widgets.push(w);
        // small timeout to ensure DOM element exists before interactable binding
        window.setTimeout(function(){
          bindInteractToWidget(w);
        }, 30);
      }

      /* Make left source items draggable (clone) */
      function makeSourceDraggable(el){
        // using interact to create dragmove that gives a dragstart clone-like effect
        interact(el).draggable({
          origin: 'parent',
          inertia: true,
          onstart: function (event){
            var type = el.getAttribute('data-type');
            // create ghost element
            var ghost = document.createElement('div');
            ghost.className = 'widget';
            ghost.style.position = 'absolute';
            ghost.style.left = (event.client.x - 20) + 'px';
            ghost.style.top = (event.client.y - 20) + 'px';
            ghost.style.pointerEvents = 'none';
            ghost.style.opacity = '0.9';
            ghost.style.width = '180px';
            ghost.style.height = '60px';
            ghost.innerHTML = '<div class="w-title">Novo ' + type + '</div><div class="w-body">Arraste para a página</div>';
            ghost.id = 'ghostDrag';
            document.body.appendChild(ghost);
          },
          onmove: function (event){
            var g = document.getElementById('ghostDrag');
            if (!g) return;
            var left = parseFloat(g.style.left || 0) + event.dx;
            var top = parseFloat(g.style.top || 0) + event.dy;
            g.style.left = left + 'px';
            g.style.top = top + 'px';
          },
          onend: function (event){
            var ghost = document.getElementById('ghostDrag');
            if (!ghost) return;
            // detect drop on page area
            var pageEl = document.getElementById('reportPage');
            var rect = pageEl.getBoundingClientRect();
            if (event.client.x >= rect.left && event.client.x <= rect.right && event.client.y >= rect.top && event.client.y <= rect.bottom){
              var type = el.getAttribute('data-type');
              addWidgetFromType(type, rect, event.client.x, event.client.y);
            }
            ghost.parentNode.removeChild(ghost);
          }
        });
      }

      /* Initialize grid background (12-col hint) */
      function initPageGrid(el){
        var pageEl = el;
        var cols = 12;
        var frag = document.createElement('div');
        frag.style.position = 'absolute';
        frag.style.inset = '0';
        frag.style.pointerEvents = 'none';
        frag.style.display = 'flex';
        for (var i=0;i<cols;i++){
          var c = document.createElement('div');
          c.style.flex = '1';
          c.style.borderLeft = '1px dashed rgba(255,255,255,0.02)';
          if (i===0) c.style.borderLeft = 'none';
          frag.appendChild(c);
        }
        pageEl.appendChild(frag);
      }

      /* Bind interactjs to a widget (drag/resize) */
      function bindInteractToWidget(widget){
        var selector = '[data-id="' + widget.id + '"]';
        var el = document.querySelector(selector);
        if (!el) return;

        // Draggable
        interact(el).draggable({
          onmove: function (event){
            widget.x += event.dx;
            widget.y += event.dy;
            // keep inside page (soft)
            var page = document.getElementById('reportPage').getBoundingClientRect();
            widget.x = Math.max(8, Math.min(widget.x, page.width - 40));
            widget.y = Math.max(8, Math.min(widget.y, page.height - 40));
          }
        });

        // Resizable from edges/corners
        interact(el).resizable({
          edges: { left:true, right:true, bottom:true, top:true },
          inertia: true,
          restrictEdges: {
            outer: 'parent',
            endOnly: true
          },
          onmove: function (event){
            var target = event.target;
            var dx = event.deltaRect.left;
            var dy = event.deltaRect.top;
            widget.w = Math.max(60, Math.round(event.rect.width));
            widget.h = Math.max(30, Math.round(event.rect.height));
            widget.x += dx;
            widget.y += dy;
          }
        });

        // clicking selects
        el.addEventListener('click', function(e){
          // prevent page click handler
          e.stopPropagation();
          selectWidget(widget, e);
        });
      }

      /* Bind all existing widgets (call later) */
      function bindAllWidgets(){
        for (var i=0;i<state.widgets.length;i++){
          bindInteractToWidget(state.widgets[i]);
        }
      }

      /* make canvas deselect on click */
      function initCanvasBehavior(){
        var page = document.getElementById('reportPage');
        if (!page) return;
        page.addEventListener('click', function(){
          state.selected = null;
        });
      }

      /* attach drop via native pointer (also allow double-click create) */
      function initPageDrop(){
        var page = document.getElementById('reportPage');
        if (!page) return;
        page.addEventListener('dblclick', function(e){
          // double click to add text element
          addWidgetFromType('text', page.getBoundingClientRect(), e.clientX, e.clientY);
        });
      }

      /* expose some methods for petite-vue template */
      return {
        state: state,
        widgetStyle: widgetStyle,
        loadDummy: loadDummy,
        clearCanvas: clearCanvas,
        selectWidget: selectWidget,
        deleteSelected: deleteSelected,
        bringToFront: bringToFront,
        exportLayout: exportLayout,
        makeSourceDraggable: makeSourceDraggable,
        initPageGrid: initPageGrid,
        bindAllWidgets: bindAllWidgets,
        initCanvasBehavior: initCanvasBehavior,
        initPageDrop: initPageDrop
      };
    }

    /* Mount petite-vue */
    window.addEventListener('DOMContentLoaded', function(){
      petiteVue.createApp().mount('#app');

      // small delay to bind interact to any widgets created later
      window.setTimeout(function(){
        // call helper to bind all (if any)
        var appScope = document.querySelector('#app').__petite_vue_app__ || null;
        // fallback: call functions via global access by querying the component instance
        // The template exposes functions on the component; we'll trigger the globals we have
        var root = document.getElementById('app');
        // invoke init canvas behaviors (we use the exposed functions from scope via dataset)
        // Because petite-vue scopes functions differently, call them by querying mounted element functions:
        try {
          // get scope methods by reading the function stored on element attribute
          var scope = root.__petite_vue_scope__ || null;
          if (scope && scope.initCanvasBehavior) scope.initCanvasBehavior();
        } catch (e){
          // graceful fallback: directly add listeners
          var page = document.getElementById('reportPage');
          if (page){
            page.addEventListener('click', function(){});
          }
        }
      }, 50);
    });

    // Workaround: bind interact for any new widget every 200ms (simple approach for prototype)
    // This meets the requirement of making drag/resize smooth without complex lifecycle hooks.
    (function pollBind(){
      window.setTimeout(function(){
        try {
          var root = document.getElementById('app');
          var scope = root && root.__petite_vue_scope__ ? root.__petite_vue_scope__ : (root && root.__petite_vue_app__ ? root.__petite_vue_app__ : null);
          if (scope && scope.state){
            for (var i=0;i<scope.state.widgets.length;i++){
              var w = scope.state.widgets[i];
              // if element exists and not yet bound (we mark a property)
              if (!w._bound){
                var el = document.querySelector('[data-id="' + w.id + '"]');
                if (el){
                  // call internal function via scope
                  if (scope.bindInteractToWidget){
                    // not exposed; use the exposed bindAllWidgets instead
                  }
                  // manual binding using exposed public function
                  if (scope.bindAllWidgets) scope.bindAllWidgets();
                  w._bound = true;
                }
              }
            }
          }
        } catch (e){}
        pollBind();
      }, 250);
    })();

  </script>
</body>
</html>

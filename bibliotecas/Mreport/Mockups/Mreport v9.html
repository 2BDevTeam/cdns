<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MReport - Sistema Professional Avançado</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/petite-vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/alasql"></script>
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        #tabela-relatorio {
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            overflow: hidden;
            background-color: white;
            margin-bottom: 40px;
        }

        .tabulator {
            border: none;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        .tabulator .tabulator-header {
            border-bottom: 2px solid #3b82f6;
            background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
            color: #1e293b;
            font-weight: 600;
            font-size: 14px;
        }

        .tabulator .tabulator-header .tabulator-col {
            background-color: transparent;
            border-right: 1px solid #e2e8f0;
        }

        .tabulator .tabulator-header .tabulator-col .tabulator-col-content {
            padding: 14px 12px;
            font-weight: 600;
        }

        .tabulator .tabulator-tableholder .tabulator-table .tabulator-row {
            background-color: transparent;
            border-bottom: 1px solid #f1f5f9;
        }

        .tabulator .tabulator-tableholder .tabulator-table .tabulator-row .tabulator-cell {
            border-right: 1px solid #f1f5f9;
            padding: 12px 14px;
        }

        /* Garantir alinhamento das células em todas as linhas */
        .tabulator-cell {
            text-align: right !important;
        }

        .tabulator-cell:first-child {
            text-align: left !important;
        }

        .tabulator-row.ativos-correntes {
            background-color: #f8fafc !important;
        }

        .tabulator-row.ativos-nao-correntes {
            background-color: transparent;
        }

        .tabulator-row.grupo-principal {
            font-weight: 700;
            background-color: #1e293b !important;
            color: white;
            font-size: 16px;
            letter-spacing: 0.3px;
        }

        .tabulator-row.subgrupo {
            font-weight: 600;
            background-color: #f1f5f9 !important;
            color: #1e293b;
            font-size: 15px;
        }

        .tabulator-row.item {
            font-weight: 400;
        }

        .tabulator-row.total {
            font-weight: 600;
            border-top: 2px solid #cbd5e1;
            background-color: #f8fafc !important;
            color: #1e293b;
        }

        .tabulator-row:hover {
            background-color: #f0f9ff !important;
        }

        .tabulator-row.grupo-principal:hover {
            background-color: #334155 !important;
        }

        .tabulator-row.subgrupo:hover {
            background-color: #e2e8f0 !important;
        }

        .valor-negativo {
            color: #dc2626;
            font-weight: 500;
        }

        .valor-positivo {
            color: #1e293b;
            font-weight: 500;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 14px;
            border-top: 1px solid #e2e8f0;
            margin-top: 30px;
        }

        .info-box {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 16px 20px;
            margin-bottom: 25px;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
            color: #1e293b;
        }

        /* Estilo para indentação dos itens */
        .item-indent {
            padding-left: 30px !important;
        }

        /* Garantir que os totais tenham o mesmo alinhamento */
        .tabulator-row.total .tabulator-cell {
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header-container {
                padding: 20px;
            }

            .header-container h1 {
                font-size: 26px;
            }

            .tabulator .tabulator-header .tabulator-col .tabulator-col-content {
                padding: 10px 8px;
                font-size: 13px;
            }

            .tabulator .tabulator-tableholder .tabulator-table .tabulator-row .tabulator-cell {
                padding: 10px 8px;
                font-size: 13px;
            }
        }

        /* Estilos para página A4 */
        @page {
            size: A4;
            margin: 0;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 9pt;
            color: #333;
            background-color: #f5f5f5;
        }

        .a4-page {
            width: 21cm;
            min-height: 29.7cm;
            padding: 1.5cm;
            margin: 0 auto 20px auto;
            box-sizing: border-box;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background: white;
            position: relative;
        }

        /* Cabeçalho do relatório */
        .report-header {
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }

        .report-title {
            font-size: 18pt;
            font-weight: bold;
            color: #2c3e50;
            margin: 0;
        }

        .report-subtitle {
            font-size: 11pt;
            color: #7f8c8d;
            margin: 5px 0 0 0;
        }

        .header-info {
            position: absolute;
            top: 0;
            right: 0;
            text-align: right;
            font-size: 9pt;
            color: #7f8c8d;
        }

        /* Rodapé do relatório */
        .report-footer {
            position: absolute;
            bottom: 1.5cm;
            left: 1.5cm;
            right: 1.5cm;
            border-top: 1px solid #bdc3c7;
            padding-top: 10px;
            font-size: 8pt;
            color: #7f8c8d;
            text-align: center;
        }

        /* Conteúdo principal */
        .page-content {
            min-height: 21cm;
            position: relative;
        }

        /* Tabela de dados */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 9pt;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .report-table th {
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #34495e;
            font-size: 9pt;
        }

        .report-table td {
            padding: 6px 10px;
            border: 1px solid #e1e1e1;
        }

        .report-table tr:nth-child(even) td {
            background-color: #f8f9fa;
        }

        /* Estilos para grupos multi-nível */
        .group-header {
            font-weight: bold;
            padding: 8px 12px;
            margin: 8px 0 4px 0;
            font-size: 10pt;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }

        .group-total {
            font-weight: bold;
            padding: 8px 12px;
            margin: 4px 0 8px 0;
            border-top: 2px solid #bdc3c7;
            border-bottom: 2px solid #bdc3c7;
            font-size: 9pt;
        }

        .grand-total {
            font-weight: bold;
            padding: 12px;
            margin-top: 15px;
            font-size: 10pt;
            text-align: center;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Objetos posicionados */
        .positioned-object {
            position: absolute;
            box-sizing: border-box;
        }

        .text-object {}

        .text-title {}

        .text-highlight {
            background: linear-gradient(135deg, #e8f4fc, #d6eaf8);
            border-left: 4px solid #3498db;
            padding: 12px;
            font-style: italic;
        }

        /* Utilitários */
        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .text-bold {
            font-weight: bold;
        }

        /* Controles */
        .controls {
            margin: 20px auto;
            width: 21cm;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 12px;
            margin-bottom: 5px;
        }

        button:hover {
            background: linear-gradient(135deg, #2980b9, #1f618d);
        }

        .stats {
            margin-top: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #e8f4fc, #d6eaf8);
            border-radius: 4px;
            font-size: 11px;
            border-left: 4px solid #3498db;
        }

        /* Painéis de configuração */
        .config-panel {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }

        .config-group {
            margin-bottom: 10px;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .config-group label {
            display: inline-block;
            width: 180px;
            font-weight: bold;
            font-size: 11px;
        }

        .config-group input,
        .config-group select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
        }

        .checkbox-group {
            display: inline-block;
            margin-right: 15px;
        }

        .color-picker {
            width: 80px;
            height: 25px;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
        }

        .tab-container {
            margin-top: 10px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            padding: 8px 15px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .tab-button.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .style-preview {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 10px;
            text-align: center;
        }

        /* Multi-select para colunas */
        .column-selector {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            max-height: 120px;
            overflow-y: auto;
            background: white;
            margin-top: 5px;
        }

        .column-option {
            padding: 3px 5px;
            cursor: pointer;
            border-radius: 3px;
            margin: 2px 0;
        }

        .column-option:hover {
            background-color: #e8f4fc;
        }

        .column-option.selected {
            background-color: #3498db;
            color: white;
        }

        /* Impressão */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background: white;
            }

            .a4-page {
                box-shadow: none;
                margin: 0;
                padding: 1.5cm;
            }

            .no-print {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="controls no-print">
        <h2>MReport - Sistema Professional Avançado</h2>
        <button id="print-btn">📄 Imprimir Relatório</button>
        <button id="generate-btn">🔄 Gerar Relatório</button>




        <div class="config-panel">
            <div class="tab-container">
                <div class="tab-buttons">
                    <div class="tab-button active" data-tab="grouping">Agrupamento</div>
                    <div class="tab-button" data-tab="styling">Estilos</div>
                    <div class="tab-button" data-tab="columns">Colunas</div>
                    <div class="tab-button" data-tab="expressions">Expressões</div>
                    <div class="tab-button" data-tab="headers">Cabeçalhos</div>
                    <div class="tab-button" data-tab="borders">Bordas</div>
                </div>

                <div class="tab-content">
                    <!-- ABA AGRUPAMENTO -->
                    <div class="tab-pane active" id="grouping">
                        <div class="config-group">
                            <label for="group-field1">Campo Agrupamento 1:</label>
                            <select id="group-field1">
                                <option value="">-- Sem agrupamento --</option>
                                <option value="categoria" selected>Categoria</option>
                                <option value="subcategoria">Subcategoria</option>
                                <option value="marca">Marca</option>
                            </select>
                        </div>

                        <div class="config-group">
                            <label for="group-field2">Campo Agrupamento 2:</label>
                            <select id="group-field2">
                                <option value="">-- Sem sub-agrupamento --</option>
                                <option value="subcategoria">Subcategoria</option>
                                <option value="marca">Marca</option>
                                <option value="categoria">Categoria</option>
                            </select>
                        </div>

                        <div class="config-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="show-group-totals" checked>
                                <label for="show-group-totals">Mostrar totais por grupo</label>
                            </div>

                            <div class="checkbox-group">
                                <input type="checkbox" id="show-grand-total" checked>
                                <label for="show-grand-total">Mostrar total geral</label>
                            </div>
                        </div>

                        <h4>Estilo dos Grupos</h4>

                        <div class="config-group">
                            <label for="group1-bg">Grupo 1 - Cor Fundo:</label>
                            <input type="color" id="group1-bg" value="#2c3e50" class="color-picker">
                            <label for="group1-text" style="width: 100px;">Cor Texto:</label>
                            <input type="color" id="group1-text" value="#ffffff" class="color-picker">
                        </div>

                        <div class="config-group">
                            <label for="group2-bg">Grupo 2 - Cor Fundo:</label>
                            <input type="color" id="group2-bg" value="#3498db" class="color-picker">
                            <label for="group2-text" style="width: 100px;">Cor Texto:</label>
                            <input type="color" id="group2-text" value="#ffffff" class="color-picker">
                        </div>
                    </div>

                    <!-- ABA ESTILOS -->
                    <div class="tab-pane" id="styling">
                        <div class="config-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="enable-colors" checked>
                                <label for="enable-colors">Habilitar cores customizadas</label>
                            </div>

                            <div class="checkbox-group">
                                <input type="checkbox" id="enable-expressions" checked>
                                <label for="enable-expressions">Habilitar expressões</label>
                            </div>

                            <div class="checkbox-group">
                                <input type="checkbox" id="enable-alternate-rows" checked>
                                <label for="enable-alternate-rows">Linhas alternadas</label>
                            </div>
                        </div>

                        <h4>Cores do Relatório</h4>

                        <div class="config-group">
                            <label for="header-bg">Cabeçalho - Fundo:</label>
                            <input type="color" id="header-bg" value="#2c3e50" class="color-picker">
                            <label for="header-text" style="width: 100px;">Texto:</label>
                            <input type="color" id="header-text" value="#ffffff" class="color-picker">
                        </div>

                        <div class="config-group">
                            <label for="even-row">Linha Par - Fundo:</label>
                            <input type="color" id="even-row" value="#f8f9fa" class="color-picker">
                            <label for="odd-row" style="width: 100px;">Linha Ímpar:</label>
                            <input type="color" id="odd-row" value="#ffffff" class="color-picker">
                        </div>

                        <div class="config-group">
                            <label for="total-bg">Total Geral - Fundo:</label>
                            <input type="color" id="total-bg" value="#2c3e50" class="color-picker">
                            <label for="total-text" style="width: 100px;">Texto:</label>
                            <input type="color" id="total-text" value="#ffffff" class="color-picker">
                        </div>
                    </div>

                    <!-- ABA COLUNAS -->
                    <div class="tab-pane" id="columns">
                        <div id="columns-config">
                            <!-- Configurações de colunas serão geradas dinamicamente -->
                        </div>
                    </div>

                    <!-- ABA EXPRESSÕES -->
                    <div class="tab-pane" id="expressions">
                        <div class="config-group">
                            <label for="global-expression">Expressão Global:</label>
                            <input type="text" id="global-expression" placeholder="ex: row.quantidade * row.preco"
                                style="width: 300px;">
                        </div>

                        <div class="config-group">
                            <label>Variáveis Disponíveis:</label>
                            <div style="font-size: 10px; color: #666;">
                                <code>row</code> (dados da linha),
                                <code>index</code> (índice),
                                <code>data</code> (todos os dados),
                                <code>formatCurrency()</code>,
                                <code>formatNumber()</code>,
                                <code>formatPercent()</code>
                            </div>
                        </div>

                        <h4>Pré-visualização de Estilos</h4>
                        <div class="style-preview" id="group1-preview" style="background-color: #2c3e50; color: white;">
                            Grupo Nível 1 - Preview
                        </div>
                        <div class="style-preview" id="group2-preview" style="background-color: #3498db; color: white;">
                            Grupo Nível 2 - Preview
                        </div>
                    </div>

                    <!-- ABA CABEÇALHOS -->
                    <div class="tab-pane" id="headers">
                        <div class="config-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="enable-group-headers" checked>
                                <label for="enable-group-headers">Habilitar cabeçalhos agrupados</label>
                            </div>
                        </div>

                        <h4>Configuração dos Cabeçalhos Agrupados</h4>

                        <div class="config-group">
                            <label for="group-header1">Cabeçalho Grupo 1:</label>
                            <input type="text" id="group-header1" value="Informações do Produto" style="width: 200px;">
                            <label style="width: 100px;">Colunas:</label>
                            <div class="column-selector" id="group-header1-cols">
                                <!-- Colunas serão preenchidas dinamicamente -->
                            </div>
                        </div>

                        <div class="config-group">
                            <label for="group-header2">Cabeçalho Grupo 2:</label>
                            <input type="text" id="group-header2" value="Dados de Venda" style="width: 200px;">
                            <label style="width: 100px;">Colunas:</label>
                            <div class="column-selector" id="group-header2-cols">
                                <!-- Colunas serão preenchidas dinamicamente -->
                            </div>
                        </div>

                        <div class="config-group">
                            <label for="group-header-bg">Cor de Fundo:</label>
                            <input type="color" id="group-header-bg" value="#34495e" class="color-picker">
                            <label for="group-header-text" style="width: 100px;">Cor do Texto:</label>
                            <input type="color" id="group-header-text" value="#ffffff" class="color-picker">
                        </div>

                        <div class="style-preview" id="group-header-preview"
                            style="background-color: #34495e; color: white;">
                            Cabeçalho Agrupado - Preview
                        </div>
                    </div>

                    <!-- ABA BORDAS -->
                    <div class="tab-pane" id="borders">
                        <h4>Configuração de Bordas</h4>

                        <div class="config-group">
                            <label for="border-style">Estilo Geral:</label>
                            <select id="border-style">
                                <option value="solid">Sólida</option>
                                <option value="dashed">Tracejada</option>
                                <option value="dotted">Pontilhada</option>
                                <option value="double">Dupla</option>
                                <option value="none">Nenhuma</option>
                            </select>
                            <label for="border-width" style="width: 100px;">Espessura:</label>
                            <select id="border-width">
                                <option value="1px">1px</option>
                                <option value="2px" selected>2px</option>
                                <option value="3px">3px</option>
                                <option value="4px">4px</option>
                            </select>
                        </div>

                        <div class="config-group">
                            <label for="border-color">Cor Geral:</label>
                            <input type="color" id="border-color" value="#34495e" class="color-picker">
                        </div>

                        <h4>Bordas Específicas</h4>

                        <div class="config-group">
                            <label for="header-border">Cabeçalho:</label>
                            <select id="header-border">
                                <option value="all">Todas as bordas</option>
                                <option value="bottom" selected>Apenas inferior</option>
                                <option value="none">Nenhuma</option>
                            </select>
                        </div>

                        <div class="config-group">
                            <label for="group-border">Grupos:</label>
                            <select id="group-border">
                                <option value="all">Todas as bordas</option>
                                <option value="left" selected>Apenas esquerda</option>
                                <option value="none">Nenhuma</option>
                            </select>
                        </div>

                        <div class="config-group">
                            <label for="total-border">Totais:</label>
                            <select id="total-border">
                                <option value="all">Todas as bordas</option>
                                <option value="top-bottom" selected>Superior e inferior</option>
                                <option value="none">Nenhuma</option>
                            </select>
                        </div>

                        <div class="style-preview" id="border-preview" style="border: 2px solid #34495e;">
                            Pré-visualização de Bordas
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats">
            <strong>Estatísticas:</strong>
            <span id="statsInfo">Carregando...</span>
        </div>
    </div>

    <div id="report-container">


    </div>

    <script>
        // ===== SISTEMA DE CONFIGURAÇÃO =====
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        class MtableStyleConfig {
            constructor(config = {}) {
                this.backgroundColor = config.backgroundColor || '#ffffff';
                this.color = config.color || '#1a365d';
                this.fontSize = config.fontSize || '13px';
                this.fontWeight = config.fontWeight || 'normal';
                this.border = config.border || {
                    borderLeft: "0px solid #e2e8f0",
                    borderRight: "0px solid #e2e8f0",
                    borderTop: "0px solid #e2e8f0",
                    borderBottom: "1px solid #e2e8f0"
                };
                this.textAlign = config.textAlign || 'left';
                this.padding = config.padding || '8px 12px';
                this.fontFamily = config.fontFamily || 'Nunito, sans-serif';
                this.forceStyle = config.forceStyle || false;
                this.enableAlternateRows = config.enableAlternateRows || true;
                this.evenRowStyle = config.evenRowStyle || {
                    backgroundColor: '#f8fafc'
                };
                this.oddRowStyle = config.oddRowStyle || {
                    backgroundColor: '#ffffff'
                };
                this.headerRowStyle = config.headerRowStyle || {
                    backgroundColor: '#1e293b',
                    color: '#ffffff',
                    fontWeight: '600',
                    fontSize: '14px',
                    borderBottom: '2px solid #0f172a'
                };
                this.totalRowStyle = config.totalRowStyle || {
                    backgroundColor: '#0f766e',
                    color: '#ffffff',
                    fontWeight: '600',
                    borderTop: '2px solid #0d9488'
                };
                this.groupHeaderRowStyle = config.groupHeaderRowStyle || {
                    backgroundColor: '#334155',
                    color: '#ffffff',
                    fontWeight: '600',
                    borderBottom: '1px solid #475569'
                };
                this.hoverRowStyle = config.hoverRowStyle || {
                    backgroundColor: '#f1f5f9'
                };
            }
        }

        class MReportConfig {
            constructor() {

                //Deve se descontinuar e passar a usar array
                this.groupConfig = {
                    field1: 'categoria',
                    field2: '',
                    showGroupTotals: true,
                    showGrandTotal: true,
                    group1Style: { backgroundColor: '#2c3e50', color: '#ffffff' },
                    group2Style: { backgroundColor: '#3498db', color: '#ffffff' }
                };


                this.styleConfig = {
                    enableAlternateRows: true,
                    headerStyle: { backgroundColor: '#2c3e50', color: '#ffffff' },
                    evenRowStyle: { backgroundColor: '#f8f9fa' },
                    oddRowStyle: { backgroundColor: '#ffffff' },
                    totalStyle: { backgroundColor: '#2c3e50', color: '#ffffff' }
                };

                this.columnConfig = {};
                this.expressions = {};

                this.headerConfig = {
                    enableGroupHeaders: true,
                    groupHeaders: [
                        {
                            title: 'Informações do Produto',
                            columns: ['categoria', 'subcategoria', 'produto', 'marca']
                        }
                    ],
                    style: { backgroundColor: '#34495e', color: '#ffffff' }
                };

                // Configurações de bordas
                this.borderConfig = {
                    style: 'solid',
                    width: '2px',
                    color: '#34495e',
                    header: 'bottom',
                    group: 'left',
                    total: 'top-bottom'
                };
            }

            loadFromUI() {
                // Agrupamento
                this.groupConfig.field1 = $('#group-field1').val();
                this.groupConfig.field2 = $('#group-field2').val();
                this.groupConfig.showGroupTotals = $('#show-group-totals').is(':checked');
                this.groupConfig.showGrandTotal = $('#show-grand-total').is(':checked');
                this.groupConfig.group1Style.backgroundColor = $('#group1-bg').val();
                this.groupConfig.group1Style.color = $('#group1-text').val();
                this.groupConfig.group2Style.backgroundColor = $('#group2-bg').val();
                this.groupConfig.group2Style.color = $('#group2-text').val();

                // Estilos
                this.styleConfig.enableColors = $('#enable-colors').is(':checked');

                this.styleConfig.enableAlternateRows = $('#enable-alternate-rows').is(':checked');
                this.styleConfig.headerStyle.backgroundColor = $('#header-bg').val();
                this.styleConfig.headerStyle.color = $('#header-text').val();
                this.styleConfig.evenRowStyle.backgroundColor = $('#even-row').val();
                this.styleConfig.oddRowStyle.backgroundColor = $('#odd-row').val();
                this.styleConfig.totalStyle.backgroundColor = $('#total-bg').val();
                this.styleConfig.totalStyle.color = $('#total-text').val();

                // Colunas
                $('.column-config').each(function () {
                    const field = $(this).data('field');
                    const config = {
                        visible: $(this).find('.col-visible').is(':checked'),
                        width: $(this).find('.col-width').val(),
                        align: $(this).find('.col-align').val(),
                        backgroundColor: $(this).find('.col-bg-color').val(),
                        textColor: $(this).find('.col-text-color').val(),
                        expression: $(this).find('.col-expression').val(),
                        border: {
                            style: $(this).find('.col-border-style').val(),
                            width: $(this).find('.col-border-width').val(),
                            color: $(this).find('.col-border-color').val()
                        }
                    };
                    this.columnConfig[field] = config;
                }.bind(this));

                // Expressões
                this.expressions.global = $('#global-expression').val();

                // Cabeçalhos agrupados
                this.headerConfig.enableGroupHeaders = $('#enable-group-headers').is(':checked');
                this.headerConfig.groupHeaders = [
                    {
                        title: $('#group-header1').val(),
                        columns: this.getSelectedColumns('group-header1-cols')
                    },
                    {
                        title: $('#group-header2').val(),
                        columns: this.getSelectedColumns('group-header2-cols')
                    }
                ];
                this.headerConfig.style.backgroundColor = $('#group-header-bg').val();
                this.headerConfig.style.color = $('#group-header-text').val();

                // Bordas
                this.borderConfig.style = $('#border-style').val();
                this.borderConfig.width = $('#border-width').val();
                this.borderConfig.color = $('#border-color').val();
                this.borderConfig.header = $('#header-border').val();
                this.borderConfig.group = $('#group-border').val();
                this.borderConfig.total = $('#total-border').val();

                return this;
            }

            getSelectedColumns(containerId) {
                const selected = [];
                $(`#${containerId} .column-option.selected`).each(function () {
                    selected.push($(this).data('field'));
                });
                return selected;
            }

            saveToUI() {
                // Agrupamento
                $('#group-field1').val(this.groupConfig.field1);
                $('#group-field2').val(this.groupConfig.field2);
                $('#show-group-totals').prop('checked', this.groupConfig.showGroupTotals);
                $('#show-grand-total').prop('checked', this.groupConfig.showGrandTotal);
                $('#group1-bg').val(this.groupConfig.group1Style.backgroundColor);
                $('#group1-text').val(this.groupConfig.group1Style.color);
                $('#group2-bg').val(this.groupConfig.group2Style.backgroundColor);
                $('#group2-text').val(this.groupConfig.group2Style.color);

                // Estilos
                $('#enable-colors').prop('checked', this.styleConfig.enableColors);
                $('#enable-alternate-rows').prop('checked', this.styleConfig.enableAlternateRows);
                $('#header-bg').val(this.styleConfig.headerStyle.backgroundColor);
                $('#header-text').val(this.styleConfig.headerStyle.color);
                $('#even-row').val(this.styleConfig.evenRowStyle.backgroundColor);
                $('#odd-row').val(this.styleConfig.oddRowStyle.backgroundColor);
                $('#total-bg').val(this.styleConfig.totalStyle.backgroundColor);
                $('#total-text').val(this.styleConfig.totalStyle.color);

                // Cabeçalhos agrupados
                $('#enable-group-headers').prop('checked', this.headerConfig.enableGroupHeaders);
                $('#group-header1').val(this.headerConfig.groupHeaders[0].title);
                $('#group-header-bg').val(this.headerConfig.style.backgroundColor);
                $('#group-header-text').val(this.headerConfig.style.color);

                // Bordas
                $('#border-style').val(this.borderConfig.style);
                $('#border-width').val(this.borderConfig.width);
                $('#border-color').val(this.borderConfig.color);
                $('#header-border').val(this.borderConfig.header);
                $('#group-border').val(this.borderConfig.group);
                $('#total-border').val(this.borderConfig.total);

                // Configurar seletores de colunas
                this.setupColumnSelectors();
                this.updatePreviews();
            }

            setupColumnSelectors() {
                const columns = reportColumns.map(col => ({ field: col.field, title: col.title }));
                this.setupColumnSelector('group-header1-cols', columns, this.headerConfig.groupHeaders[0].columns);
            }

            setupColumnSelector(containerId, columns, selectedColumns) {
                const $container = $(`#${containerId}`);
                $container.empty();

                columns.forEach(col => {
                    const isSelected = selectedColumns.includes(col.field);
                    const $option = $('<div>', {
                        class: `column-option ${isSelected ? 'selected' : ''}`,
                        'data-field': col.field,
                        text: col.title
                    });

                    $option.on('click', function () {
                        $(this).toggleClass('selected');
                    });

                    $container.append($option);
                });
            }

            updatePreviews() {
                $('#group1-preview').css({
                    'background-color': this.groupConfig.group1Style.backgroundColor,
                    'color': this.groupConfig.group1Style.color
                });

                $('#group2-preview').css({
                    'background-color': this.groupConfig.group2Style.backgroundColor,
                    'color': this.groupConfig.group2Style.color
                });

                $('#group-header-preview').css({
                    'background-color': this.headerConfig.style.backgroundColor,
                    'color': this.headerConfig.style.color
                });

                $('#border-preview').css({
                    'border-style': this.borderConfig.style,
                    'border-width': this.borderConfig.width,
                    'border-color': this.borderConfig.color
                });
            }

            getDefaultConfig() {
                return new MReportConfig();
            }
        }

        // ===== ESTRUTURA DE CÉLULAS E LINHAS =====
        class MTableCell {
            constructor(value, config = {}) {
                this.value = value;
                this.config = config;
                this.rowSpan = config.rowSpan || 1;
                this.colSpan = config.colSpan || 1;
                this.style = config.style || {};
                this.border = config.border || {};
            }

            render() {


                //  console.log("Renderizando célula:", this.style);
                const $cell = $('<td>', {
                    text: this.value,
                    attr: {
                        rowspan: this.rowSpan > 1 ? this.rowSpan : null,
                        colspan: this.colSpan > 1 ? this.colSpan : null
                    },
                    css: {
                        ...this.style,
                        ...this.getBorderStyle()
                    }
                });
                return $cell;
            }

            getBorderStyle() {
                const borderStyle = {};
                if (this.border.style && this.border.width && this.border.color) {
                    borderStyle.border = `${this.border.width} ${this.border.style} ${this.border.color}`;
                }
                return borderStyle;
            }
        }

        class MTableRow {
            constructor(cells = [], config = {}) {
                this.cells = cells;
                this.config = config;
                this.type = config.type || 'data'; // 'header', 'group', 'total', 'data'
                this.style = config.style || {};
                this.height = config.height || null;
            }

            addCell(cell) {
                this.cells.push(cell);
                return this;
            }

            render() {
                const $row = $('<tr>', {
                    css: {
                        ...this.style,
                        height: this.height ? `${this.height}px` : 'auto'
                    }
                });

                this.cells.forEach(cell => {
                    $row.append(cell.render());
                });

                return $row;
            }

            getHeight() {
                return this.height || 28; // Altura padrão
            }
        }


        // ===== SISTEMA DE OBJETOS COM POSICIONAMENTO =====
        class MObject {
            constructor(type, config = {}) {
                this.type = type;
                this.config = config;
                this.breakable = false;
                this.minHeight = config.minHeight || 40;

                this.x = config.x || 0;
                this.y = config.y || 0;
                this.width = config.width || 200;
                this.height = config.height || 100;
                this.section = config.section || 'content';
            }

            getPosition() {
                return { x: this.x, y: this.y, width: this.width, height: this.height, section: this.section };
            }

            getHeight() {
                return this.height;
            }

            canBreak() {
                return this.breakable;
            }

            render(mainContainer) {
                const $container = $('<div>', {
                    class: 'positioned-object',
                    css: {
                        transform: `translate3d(${this.x}px, ${this.y}px, 0)`,
                        width: `${this.width}px`,
                        height: `${this.height}px`,
                        ...(this.config.style ? $.parseStyle(this.config.style) : {})
                    }
                });

                mainContainer.append($container);

                const $content = this.renderContent($container);
                if ($content) $container.append($content);

                return $container;
            }

            renderContent(container) {
                return $('<div>');
            }

            split(availableHeight) {
                return { fitted: this, remaining: null };
            }
        }

        // ===== OBJETO TABELA AVANÇADO =====
        class MTableObject extends MObject {
            constructor(data, columns, config = {}) {
                super('table', config);
                this.data = data;
                this.columns = columns;
                this.breakable = true;
                this.rowHeight = config.rowHeight || 40;
                this.headerHeight = config.headerHeight || 40;
                this.groupHeaderHeight = config.groupHeaderHeight || 40;
                this.groupTotalHeight = config.groupTotalHeight || 40;
                this.reportConfig = config.reporntConfig || new MReportConfig();
                this.renderedRows = config.renderedRows

            }



            setRenderedRows(rows) {
                this.renderedRows = rows;
                return this;
            }

            addRenderedRow(row) {
                if (row instanceof MTableRow) {
                    this._renderedRows.push(row);
                }
                return this;
            }
            getHeight() {
                let height = this.headerHeight;

                if (this.reportConfig.headerConfig.enableGroupHeaders) {
                    height += 30;
                }

                this.data.forEach(item => {
                    if (item.type === 'group-header' || item.type === 'group-total') {
                        height += this.groupHeaderHeight;
                    } else if (item.type === 'grand-total') {
                        height += 45;
                    } else {
                        height += item._rowHeight || this.rowHeight;
                    }
                });
                return height;
            }

            renderContent(container) {
                const $container = $('<div>', {
                    css: {
                        width: '100%',
                        height: '100%',
                        overflow: 'hidden'
                    }
                });

                var containerId = "table-container-" + generateUUID();
                //const tableStructure = this.createTableStructure();
                var tableDivHtml = $("<div id='" + containerId + "'></div>");

                container.append(tableDivHtml);

                console.log("container", container.html());

                // Dados para a tabela
                var tableData = [

                    { descricao: "ACTIVOS", A2022: "", ND: "", variacao: "", variacaoPercent: "", nivel: "principal" },
                    { descricao: "Activos correntes", A2022: "", ND: "", variacao: "", variacaoPercent: "", nivel: "subgrupo", classe: "ativos-correntes" },
                    { descricao: "Inventários", A2022: "13 098 600 578.17", ND: "0.00", variacao: "13 098 600 578.17", variacaoPercent: "", nivel: "item" },
                    { descricao: "Activos biológicos", A2022: "0.00", ND: "0.00", variacao: "0.00", variacaoPercent: "0", nivel: "item" },
                    { descricao: "Clientes", A2022: "38 550 426 756.25", ND: "0.00", variacao: "38 550 426 756.25", variacaoPercent: "", nivel: "item" },
                    { descricao: "Outros activos financeiros", A2022: "0.00", ND: "0.00", variacao: "0.00", variacaoPercent: "0", nivel: "item" },
                    { descricao: "Outros activos correntes", A2022: "58 938 683 101.17", ND: "0.00", variacao: "58 938 683 101.17", variacaoPercent: "", nivel: "item" },
                    { descricao: "Caixa e bancos", A2022: "58 090 014 044.90", ND: "0.00", variacao: "58 090 014 044.90", variacaoPercent: "", nivel: "item" },
                    { descricao: "Activos não correntes detidos para venda", A2022: "267 111 300.00", ND: "0.00", variacao: "267 111 300.00", variacaoPercent: "", nivel: "item" },
                    { descricao: "Total- Activos correntes", A2022: "168 944 835 780.49", ND: "0.00", variacao: "168 944 835 780.49", variacaoPercent: "", nivel: "total" },
                    { descricao: "Activos não correntes", A2022: "", ND: "", variacao: "", variacaoPercent: "", nivel: "subgrupo", classe: "ativos-nao-correntes" },
                    { descricao: "Activos tangíveis", A2022: "391 433 875 825.82", ND: "0.00", variacao: "391 433 875 825.82", variacaoPercent: "", nivel: "item" },
                    { descricao: "Activos tangíveis de investimento", A2022: "13 620 279 102.37", ND: "0.00", variacao: "13 620 279 102.37", variacaoPercent: "", nivel: "item" },
                    { descricao: "Goodwill", A2022: "73 808 085.20", ND: "0.00", variacao: "73 808 085.20", variacaoPercent: "", nivel: "item" },
                    { descricao: "Activos intangíveis", A2022: "220 747 032 462.59", ND: "0.00", variacao: "220 747 032 462.59", variacaoPercent: "", nivel: "item" },
                    { descricao: "Activos biológicos", A2022: "0.00", ND: "0.00", variacao: "0.00", variacaoPercent: "0", nivel: "item" },
                    { descricao: "Investimentos em associadas", A2022: "31 499 049 473.35", ND: "0.00", variacao: "31 499 049 473.35", variacaoPercent: "", nivel: "item" },
                    { descricao: "Investimentos em subsidiárias", A2022: "0.00", ND: "0.00", variacao: "0.00", variacaoPercent: "0", nivel: "item" }
                ];


                // Configuração da tabela
                var table = new Tabulator("#" + containerId, {
                    data: this.data,
                    layout: "fitColumns",
                    rowHeight: 40,
                    columns: this.getVisibleColumns(),
                    // No lugar do rowFormatter atual, usar este:
                    // No método renderContent do MTableObject, ajuste o rowFormatter:
                    rowFormatter: function (row) {
                        var data = row.getData();
                        var nivel = data.nivel;
                        var level = data.level;
                        var type = data.type;

                        // Limpar todas as classes primeiro
                        var rowElement = row.getElement();
                        rowElement.className = 'tabulator-row';

                        // Aplicar estilos baseados no tipo/nível
                        if (type === 'group-header') {
                            if (level === 0) {
                                rowElement.classList.add("grupo-principal");
                            } else {
                                rowElement.classList.add("subgrupo");
                            }

                            // Aplicar cores customizadas se existirem
                            if (data._rowColor) {
                                rowElement.style.backgroundColor = data._rowColor;
                            }
                            if (data._textColor) {
                                rowElement.style.color = data._textColor;
                            }
                        }
                        else if (type === 'group-total') {
                            rowElement.classList.add("total");
                            if (data._rowColor) {
                                rowElement.style.backgroundColor = data._rowColor;
                            }
                            if (data._textColor) {
                                rowElement.style.color = data._textColor;
                            }
                        }
                        else if (type === 'grand-total') {
                            rowElement.classList.add("total");
                            rowElement.style.backgroundColor = '#2c3e50';
                            rowElement.style.color = '#ffffff';
                        }
                        else if (nivel === 'item') {
                            rowElement.classList.add("item");
                        }

                        // Aplicar altura customizada
                        if (data._rowHeight) {
                            rowElement.style.height = data._rowHeight + 'px';
                        }
                    }
                });



                return $container;
            }

            createTableStructure = () => {
                const $table = $('<table>', { class: 'report-table' });
                const $thead = $('<thead>');
                const $tbody = $('<tbody>');

                // Limpar array de linhas renderizadas

                // Adicionar cabeçalhos agrupados 
                if (this.reportConfig.headerConfig.enableGroupHeaders) {
                    const groupHeaderRow = this.createGroupHeaderRow();
                    $thead.append(groupHeaderRow.render());
                    this.renderedRows.push(groupHeaderRow);
                }

                // Adicionar cabeçalho normal
                const headerRow = this.createHeaderRow();
                $thead.append(headerRow.render());
                this.renderedRows.push(headerRow);

                $table.append($thead);

                // Processar dados e criar linhas
                this.data.forEach((item, index) => {
                    let row;

                    if (item.type === 'group-header') {
                        row = this.createGroupHeaderRow(item);
                    } else if (item.type === 'group-total') {
                        row = this.createGroupTotalRow(item);
                    } else if (item.type === 'grand-total') {
                        row = this.createGrandTotalRow(item);
                    } else {
                        row = this.createDataRow(item, index);
                    }

                    if (row) {
                        $tbody.append(row.render());
                        this.renderedRows.push(row);


                    }
                });

                $table.append($tbody);
                return $table;
            };

            addToRendered(row) {
                this.renderedRows.push(row);
            }
            createGroupHeaderRow(groupData = null) {
                const cells = [];
                const borderConfig = this.reportConfig.borderConfig;

                if (groupData) {
                    // Cabeçalho de grupo normal
                    const groupStyle = groupData.level === 1 ?
                        this.reportConfig.groupConfig.group1Style :
                        this.reportConfig.groupConfig.group2Style;

                    const cell = new MTableCell(
                        `${this.getGroupLabel(groupData.groupField)}: ${groupData.value}`,
                        {
                            colSpan: this.getVisibleColumns().length,
                            style: {
                                ...groupStyle,
                                fontWeight: 'bold',
                                padding: '8px 12px',
                                fontSize: '10pt'
                            },
                            border: this.getBorderStyleForType('group')
                        }
                    );
                    cells.push(cell);
                } else {
                    // Cabeçalhos agrupados
                    const columnSpans = this.calculateColumnSpans(this.getVisibleColumns());
                    columnSpans.forEach(spanInfo => {
                        const cell = new MTableCell(spanInfo.title, {
                            colSpan: spanInfo.span,
                            style: {
                                textAlign: 'center',
                                backgroundColor: this.reportConfig.headerConfig.style.backgroundColor,
                                color: this.reportConfig.headerConfig.style.color,
                                fontWeight: 'bold',
                                fontSize: '10pt',
                                padding: '6px 10px'
                            },
                            border: this.getBorderStyleForType('header')
                        });
                        cells.push(cell);
                    });
                }

                return new MTableRow(cells, {
                    type: groupData ? 'group-header' : 'grouped-header',
                    height: groupData ? this.groupHeaderHeight : 30
                });
            }

            getGroupedHeaderRow() {
                return this.renderedRows.find(row => row.type === 'grouped-header');
            }

            hasGroupedHeaderRow() {

                return this.renderedRows.filter(row => row.type === 'grouped-header').length > 0;
            }
            createHeaderRow() {
                const cells = [];
                const visibleColumns = this.getVisibleColumns();

                visibleColumns.forEach(col => {
                    const cell = new MTableCell(col.title, {
                        style: {
                            textAlign: col.config?.align || 'left',
                            backgroundColor: this.reportConfig.styleConfig.headerStyle.backgroundColor,
                            color: this.reportConfig.styleConfig.headerStyle.color,
                            fontWeight: '600',
                            fontSize: '9pt',
                            padding: '8px 10px'
                        },
                        border: this.getBorderStyleForType('header')
                    });
                    cells.push(cell);
                });

                return new MTableRow(cells, {
                    type: 'header',
                    height: this.headerHeight
                });
            }

            getHeaderRow() {
                return this.renderedRows.find(row => row.type === 'header');
            }
            hasHeaderRow() {
                return this.renderedRows.filter(row => row.type === 'header').length > 0;
            }

            getBodyRows() {
                return this.renderedRows.filter(row => row.type != 'grouped-header' && row.type != 'header');
            }

            createDataRow(item, rowIndex) {
                const cells = [];
                const visibleColumns = this.getVisibleColumns();
                const rowStyle = {};

                // Aplicar estilo da linha
                if (this.reportConfig.styleConfig.enableAlternateRows) {
                    const altStyle = rowIndex % 2 === 0 ?
                        this.reportConfig.styleConfig.evenRowStyle :
                        this.reportConfig.styleConfig.oddRowStyle;
                    rowStyle.backgroundColor = altStyle.backgroundColor;
                }

                if (item._rowColor) {
                    rowStyle.backgroundColor = item._rowColor;
                }

                visibleColumns.forEach(col => {
                    let value = item[col.field];

                    // Processar expressões

                    if (col.config?.expression) {
                        try {
                            value = this.evaluateExpression(col.config.expression, item, rowIndex);
                        } catch (e) {
                            console.error('Erro na expressão:', e);
                            value = 'Erro';
                        }
                    }
                    else {
                        value = this.formatValue(value, col.type);
                    }

                    const cellStyle = {
                        textAlign: col.config?.align || 'left',
                        padding: '6px 10px',
                        fontSize: '9pt'
                    };

                    // Aplicar estilo da coluna
                    if (col.config?.backgroundColor) cellStyle.backgroundColor = col.config.backgroundColor;
                    if (col.config?.textColor) cellStyle.color = col.config.textColor;
                    if (col.config?.fontWeight) cellStyle.fontWeight = col.config.fontWeight;

                    // Estilo individual da célula
                    if (item[`_cell_${col.field}_color`]) {
                        cellStyle.backgroundColor = item[`_cell_${col.field}_color`];
                    }
                    if (item[`_cell_${col.field}_textColor`]) {
                        cellStyle.color = item[`_cell_${col.field}_textColor`];
                    }

                    const cell = new MTableCell(value, {
                        style: cellStyle,
                        border: this.getBorderStyleForType('data')
                    });
                    cells.push(cell);
                });

                return new MTableRow(cells, {
                    type: 'data',
                    style: rowStyle,
                    height: item._rowHeight || this.rowHeight
                });
            }

            createGroupTotalRow(groupData) {
                const groupStyle = groupData.level === 1 ?
                    this.reportConfig.groupConfig.group1Style :
                    this.reportConfig.groupConfig.group2Style;

                const totals = this.calculateGroupTotals(groupData.data);
                const totalText = this.formatGroupTotal(groupData, totals);

                const cell = new MTableCell(totalText, {
                    colSpan: this.getVisibleColumns().length,
                    style: {
                        ...groupStyle,
                        fontWeight: 'bold',
                        padding: '8px 12px',
                        fontSize: '9pt'
                    },
                    border: this.getBorderStyleForType('total')
                });

                return new MTableRow([cell], {
                    type: 'group-total',
                    height: this.groupTotalHeight
                });
            }

            createGrandTotalRow(totalData) {
                const totals = this.calculateGrandTotals(totalData.data);
                const totalText = this.formatGrandTotal(totals);

                const cell = new MTableCell(totalText, {
                    colSpan: this.getVisibleColumns().length,
                    style: {
                        ...this.reportConfig.styleConfig.totalStyle,
                        fontWeight: 'bold',
                        padding: '12px',
                        fontSize: '10pt',
                        textAlign: 'center'
                    },
                    border: this.getBorderStyleForType('total')
                });

                return new MTableRow([cell], {
                    type: 'grand-total',
                    height: 45
                });
            }

            getBorderStyleForType(type) {
                const config = this.reportConfig.borderConfig;
                let borderStyle = {};

                switch (type) {
                    case 'header':
                        if (config.header === 'all') {
                            borderStyle = { style: config.style, width: config.width, color: config.color };
                        } else if (config.header === 'bottom') {
                            borderStyle = {
                                style: config.style,
                                width: config.width,
                                color: config.color,
                                specific: '0 0 2px 0' // Apenas borda inferior
                            };
                        }
                        break;

                    case 'group':
                        if (config.group === 'all') {
                            borderStyle = { style: config.style, width: config.width, color: config.color };
                        } else if (config.group === 'left') {
                            borderStyle = {
                                style: config.style,
                                width: config.width,
                                color: config.color,
                                specific: '0 0 0 4px' // Apenas borda esquerda
                            };
                        }
                        break;

                    case 'total':
                        if (config.total === 'all') {
                            borderStyle = { style: config.style, width: config.width, color: config.color };
                        } else if (config.total === 'top-bottom') {
                            borderStyle = {
                                style: config.style,
                                width: config.width,
                                color: config.color,
                                specific: '2px 0' // Apenas bordas superior e inferior
                            };
                        }
                        break;

                    case 'data':
                    default:
                        borderStyle = { style: config.style, width: config.width, color: config.color };
                        break;
                }

                return borderStyle;
            }

            // Métodos auxiliares mantidos da versão anterior
            calculateColumnSpans(visibleColumns) {
                const spans = [];
                const groupHeaders = this.reportConfig.headerConfig.groupHeaders;
                const groupedColumns = new Set();

                groupHeaders.forEach(groupHeader => {
                    groupHeader.columns.forEach(col => groupedColumns.add(col));
                });

                const ungroupedColumns = visibleColumns.filter(col =>
                    !groupedColumns.has(col.field)
                );

                groupHeaders.forEach(groupHeader => {
                    let spanCount = 0;
                    visibleColumns.forEach(col => {
                        if (groupHeader.columns.includes(col.field)) {
                            spanCount++;
                        }
                    });
                    if (spanCount > 0) {
                        spans.push({
                            title: groupHeader.title,
                            span: spanCount
                        });
                    }
                });

                if (ungroupedColumns.length > 0) {
                    spans.push({
                        title: '',
                        span: ungroupedColumns.length
                    });
                }

                return spans;
            }

            getVisibleColumns() {
                return this.columns.filter(col => {
                    const config = this.reportConfig.columnConfig[col.field];
                    return !config || config.visible !== false;
                });
            }

            evaluateExpression(expression, item, rowIndex) {
                const context = {
                    row: item,
                    index: rowIndex,
                    data: this.data,
                    formatCurrency: (value) => parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
                    formatNumber: (value) => parseInt(value).toLocaleString('pt-BR'),
                    formatPercent: (value) => parseFloat(value).toLocaleString('pt-BR', { style: 'percent', minimumFractionDigits: 2 })
                };
                const evalExpression = new Function(...Object.keys(context), `return ${expression}`);
                return evalExpression(...Object.values(context));
            }

            calculateGroupTotals(groupData) {
                const totals = {};
                this.getVisibleColumns().forEach(col => {
                    if (col.type === 'numeric' || col.type === 'currency') {
                        totals[col.field] = 0;
                        groupData.forEach(item => {
                            if (!item.type) {
                                const value = parseFloat(item[col.field]) || 0;
                                totals[col.field] += value;
                            }
                        });
                    }
                });
                return totals;
            }

            calculateGrandTotals(allData) {
                const totals = {};
                this.getVisibleColumns().forEach(col => {
                    if (col.type === 'numeric' || col.type === 'currency') {
                        totals[col.field] = 0;
                        allData.forEach(item => {
                            if (!item.type) {
                                const value = parseFloat(item[col.field]) || 0;
                                totals[col.field] += value;
                            }
                        });
                    }
                });
                return totals;
            }

            getGroupLabel(field) {
                const column = this.columns.find(col => col.field === field);
                return column ? column.title : field;
            }

            formatGroupTotal(item, totals) {
                let text = `Total ${this.getGroupLabel(item.groupField)} ${item.value}: `;
                let first = true;
                this.getVisibleColumns().forEach(col => {
                    if ((col.type === 'numeric' || col.type === 'currency') && totals[col.field] !== undefined) {
                        if (!first) text += ' | ';
                        text += `${col.title}: ${this.formatValue(totals[col.field], col.type)}`;
                        first = false;
                    }
                });
                return text;
            }

            formatGrandTotal(totals) {
                let text = 'TOTAL GERAL: ';
                let first = true;
                this.getVisibleColumns().forEach(col => {
                    if ((col.type === 'numeric' || col.type === 'currency') && totals[col.field] !== undefined) {
                        if (!first) text += ' | ';
                        text += `${col.title}: ${this.formatValue(totals[col.field], col.type)}`;
                        first = false;
                    }
                });
                return text;
            }

            formatValue(value, type) {
                if (value === null || value === undefined) return '-';
                switch (type) {
                    case 'numeric': return parseInt(value).toLocaleString('pt-BR');
                    case 'currency': return parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    case 'percent': return parseFloat(value).toLocaleString('pt-BR', { style: 'percent', minimumFractionDigits: 2 });
                    default: return value.toString();
                }
            }

            split(availableHeight) {
                const effectiveAvailableHeight = availableHeight - this.y;

                if (effectiveAvailableHeight < this.headerHeight + 40) {
                    return { fitted: null, remaining: this };
                }

                let currentHeight = this.headerHeight;
                if (this.reportConfig.headerConfig.enableGroupHeaders) {
                    currentHeight += 30;
                }

                const fittedData = [];
                const remainingData = [];
                let splitIndex = -1;

                for (let i = 0; i < this.data.length; i++) {
                    const item = this.data[i];
                    const itemHeight = this.getItemHeight(item);

                    if (currentHeight + itemHeight <= effectiveAvailableHeight) {
                        fittedData.push(item);
                        currentHeight += itemHeight;
                    } else {
                        splitIndex = i;
                        break;
                    }
                }

                if (splitIndex !== -1) {
                    remainingData.push(...this.data.slice(splitIndex));
                }

                const fittedTable = fittedData.length > 0 ?
                    new MTableObject(fittedData, this.columns, {
                        ...this.config,
                        reportConfig: this.reportConfig
                    }) : null;

                const remainingTable = remainingData.length > 0 ?
                    new MTableObject(remainingData, this.columns, {
                        ...this.config,
                        reportConfig: this.reportConfig,
                        x: this.x,
                        y: 0,
                        renderedRows: []
                    }) : null;

                return { fitted: fittedTable, remaining: remainingTable };
            }

            getItemHeight(item) {
                if (item.type === 'group-header' || item.type === 'group-total') {
                    return this.groupHeaderHeight;
                } else if (item.type === 'grand-total') {
                    return 45;
                }
                return item._rowHeight || this.rowHeight;
            }

            // Método para acessar as linhas renderizadas
            getRenderedRows() {
                return this.renderedRows;
            }

            // Método para acessar células específicas
            getCell(rowIndex, cellIndex) {
                if (this.renderedRows[rowIndex] && this.renderedRows[rowIndex].cells[cellIndex]) {
                    return this.renderedRows[rowIndex].cells[cellIndex];
                }
                return null;
            }
        }


        // ===== CLASSES RESTANTES (MReport, MPageManager, MTextObject, etc.) =====
        // [Manter as classes MReport, MPageManager, MTextObject, MObject e funções auxiliares da versão anterior]
        // ... (o restante do código permanece igual)

        // ===== OBJETO TEXTO =====
        class MTextObject extends MObject {
            constructor(content, config = {}) {
                super('text', config);
                this.content = content;
                this.breakable = false;

                if (config.styleType === 'title') {
                    this.config.style = 'font-size: 14pt; font-weight: bold; z-index: 10;';
                    this.height = 60;
                } else if (config.styleType === 'highlight') {
                    this.config.style = 'font-size: 10pt; z-index: 10;';
                    this.height = 70;
                }
            }

            renderContent(container) {
                const $div = $('<div>', {
                    class: `text-object ${this.config.styleType ? 'text-' + this.config.styleType : ''}`,
                    css: {
                        width: '100%',
                        height: '100%',
                        overflow: 'hidden'
                    },
                    html: this.content
                });
                return $div;
            }
        }

        // ===== GERENCIADOR DE PÁGINAS =====
        class MPageManager {
            constructor(config = {}) {
                this.config = {
                    pageWidth: 794,
                    pageHeight: 1123,
                    margin: 57,
                    ...config
                };

                this.pages = [];
                this.currentPage = null;
            }

            createNewPage() {
                const page = {
                    header: { objects: [], height: 0 },
                    content: { objects: [], height: 0 },
                    footer: { objects: [], height: 0 },
                    usedHeight: 0,
                    maxHeight: 21 * 37.8
                };
                this.pages.push(page);
                this.currentPage = page;
                return page;
            }

            addObjectToPage(object) {
                const targetPage = this.currentPage;
                if (!targetPage) return false;

                const section = object.section || 'content';
                const objectHeight = object.getHeight();



                const availableHeight = targetPage.maxHeight - targetPage.usedHeight;

                if (object.canBreak()) {

                    const splitResult = object.split(availableHeight);

                    if (splitResult.fitted) {
                        targetPage[section].objects.push(splitResult.fitted);
                        targetPage.usedHeight += splitResult.fitted.getHeight();
                    }

                    if (splitResult.remaining) {
                        this.createNewPage();

                        this.addObjectToPage(splitResult.remaining);
                    }
                } else {
                    if (objectHeight <= availableHeight) {
                        targetPage[section].objects.push(object);
                        targetPage.usedHeight += objectHeight;
                    } else {
                        this.createNewPage();

                        return this.addObjectToPage(object);
                    }
                }

                return true;
            }

            renderPages(containerId) {
                const $container = $('#' + containerId);
                $container.empty();

                this.pages.forEach((page, pageIndex) => {
                    const $pageElement = this.createPageElement(page, pageIndex + 1, this.pages.length, $container);
                    //   $container.append($pageElement);
                });

                return this.pages.length;
            }

            createPageElement(page, pageNumber, totalPages, container) {
                const $pageDiv = $('<div>', { class: 'a4-page' });

                // Header
                const $headerDiv = $('<div>', { class: 'report-header' });

                container.append($pageDiv);

                const $title = $('<h1>', {
                    class: 'report-title',
                    text: 'RELATÓRIO DE VENDAS - MULTI-NÍVEL'
                });
                $headerDiv.append($title);

                const $subtitle = $('<p>', {
                    class: 'report-subtitle',
                    text: 'Análise detalhada por categoria e subcategoria'
                });
                $headerDiv.append($subtitle);

                const $headerInfo = $('<div>', {
                    class: 'header-info',
                    html: `
                        Página ${pageNumber} de ${totalPages}<br>
                        Data: ${new Date().toLocaleDateString('pt-BR')}<br>
                        Hora: ${new Date().toLocaleTimeString('pt-BR')}
                    `
                });
                $headerDiv.append($headerInfo);

                // Objetos do header
                const $headerObjectsDiv = $('<div>', {
                    css: {
                        position: 'relative',
                        minHeight: '50px'
                    }
                });

                $pageDiv.append($headerDiv);
                page.header.objects.forEach(obj => {
                    $headerObjectsDiv.append(obj.render($headerDiv));
                });
                $headerDiv.append($headerObjectsDiv);


                // Content
                const $contentDiv = $('<div>', { class: 'page-content' });

                $pageDiv.append($contentDiv);
                page.content.objects.forEach(obj => {

                    $contentDiv.append(obj.render($contentDiv));
                });


                // Footer
                const $footerDiv = $('<div>', { class: 'report-footer' });

                const $footerObjectsDiv = $('<div>', {
                    css: {
                        position: 'relative',
                        minHeight: '30px'
                    }
                });

                page.footer.objects.forEach(obj => {
                    $footerObjectsDiv.append(obj.render($footerDiv));
                });
                $footerDiv.append($footerObjectsDiv);

                const $footerText = $('<div>', {
                    css: { textAlign: 'center' },
                    text: `MReport Professional System - Página ${pageNumber} de ${totalPages} - ${new Date().getFullYear()}`
                });
                $footerDiv.append($footerText);

                $pageDiv.append($footerDiv);

                return $pageDiv;
            }

            getStats() {
                const totalObjects = this.pages.reduce((sum, page) =>
                    sum + page.header.objects.length + page.content.objects.length + page.footer.objects.length, 0);
                return {
                    totalPages: this.pages.length,
                    totalObjects: totalObjects
                };
            }
        }

        // ===== SISTEMA MREPORT PRINCIPAL =====
        class MReport {
            constructor() {
                this.pageManager = new MPageManager();
                this.objects = [];
                this.config = new MReportConfig();
            }

            setConfig(config) {
                this.config = config;
                return this;
            }

            addObject(object) {
                this.objects.push(object);
                return this;
            }

            addText(content, config = {}) {
                const textObject = new MTextObject(content, config);
                return this.addObject(textObject);
            }

            addTable(data, columns, config = {}) {
                config.renderedRows = [];
                const tableObject = new MTableObject(data, columns, {
                    ...config,
                    reportConfig: this.config
                });
                return this.addObject(tableObject);
            }

            generate(containerId) {
                this.pageManager.createNewPage();

                this.objects.forEach(object => {
                    this.pageManager.addObjectToPage(object);
                });

                const totalPages = this.pageManager.renderPages(containerId);

                return this;
            }

            updateStats(stats) {
                const $statsInfo = $('#statsInfo');
                if ($statsInfo.length) {
                    $statsInfo.text(
                        `${stats.totalPages} páginas | ${stats.totalObjects} objetos | ${this.objects.length} objetos totais`
                    );
                }
            }

            clear() {
                this.objects = [];
                this.pageManager = new MPageManager();
                return this;
            }
        }

        // ===== DADOS E CONFIGURAÇÕES =====
        function generateTestData() {
            const categorias = ['Eletrônicos', 'Livros', 'Roupas', 'Casa', 'Esportes'];
            const subcategorias = {
                'Eletrônicos': ['Smartphones', 'Tablets', 'Notebooks', 'Acessórios'],
                'Livros': ['Ficção', 'Não-Ficção', 'Técnicos', 'Infantil'],
                'Roupas': ['Masculino', 'Feminino', 'Infantil', 'Esportiva'],
                'Casa': ['Móveis', 'Decoração', 'Cozinha', 'Jardim'],
                'Esportes': ['Fitness', 'Camping', 'Aquáticos', 'Coletivos']
            };
            const marcas = ['Samsung', 'Apple', 'Sony', 'LG', 'Xiaomi', 'Nike', 'Adidas', 'Philips', 'Brastemp'];

            const data = [];
            for (let i = 1; i <= 50; i++) {
                const categoria = categorias[Math.floor(Math.random() * categorias.length)];
                const subcatArray = subcategorias[categoria];
                const subcategoria = subcatArray[Math.floor(Math.random() * subcatArray.length)];

                data.push({
                    id: i,
                    categoria: categoria,
                    subcategoria: subcategoria,
                    produto: `Produto ${i} - ${categoria}`,
                    marca: marcas[Math.floor(Math.random() * marcas.length)],
                    quantidade: Math.floor(Math.random() * 100) + 1,
                    preco: parseFloat((Math.random() * 1000 + 10).toFixed(2)),
                    total: 0
                });

                data[data.length - 1].total = data[data.length - 1].quantidade * data[data.length - 1].preco;
            }

            return data;
        }

        const reportColumns = [
            {
                field: "categoria",
                title: "Categoria",
                type: "text",
                widthGrow: 2,
                headerSort: false,
                resizable: false,
            },
            {
                field: "subcategoria",
                title: "Subcategoria",
                type: "text",
                widthGrow: 2,
                headerSort: false,
                resizable: false
            },
            {
                field: "produto",
                title: "Produto",
                type: "text",
                widthGrow: 2,
                headerSort: false,
                resizable: false,
            },
            {
                field: "marca",
                title: "Marca",
                type: "text",
                widthGrow: 2,
                headerSort: false,
                resizable: false,
            },
            {
                field: "quantidade",
                title: "Quantidade",
                type: "numeric",
                widthGrow: 2,
                headerSort: false,
                resizable: false,
            },
            {
                field: "preco",
                title: "Preço Unit.",
                type: "currency",
                widthGrow: 2,
                headerSort: false,
                resizable: false,
            },
            {
                field: "total",
                title: "Total",
                type: "currency",
                widthGrow: 2,
                headerSort: false,
                resizable: false,
            }
        ];

        function processDataWithGroups(data, groupConfig) {
            if (!groupConfig.field1) return data;

            const result = [];

            // Primeiro nível de agrupamento
            const grouped1 = {};
            data.forEach(item => {
                const key = item[groupConfig.field1];
                if (!grouped1[key]) grouped1[key] = [];
                grouped1[key].push(item);
            });

            Object.keys(grouped1).sort().forEach(key1 => {
                result.push({
                    type: 'group-header',
                    level: 1,
                    value: key1,
                    groupField: groupConfig.field1,
                    data: grouped1[key1]
                });

                // Segundo nível de agrupamento (se existir)
                if (groupConfig.field2) {
                    const grouped2 = {};
                    grouped1[key1].forEach(item => {
                        const key2 = item[groupConfig.field2];
                        if (!grouped2[key2]) grouped2[key2] = [];
                        grouped2[key2].push(item);
                    });

                    Object.keys(grouped2).sort().forEach(key2 => {
                        result.push({
                            type: 'group-header',
                            level: 2,
                            value: key2,
                            groupField: groupConfig.field2,
                            data: grouped2[key2]
                        });

                        result.push(...grouped2[key2]);

                        if (groupConfig.showGroupTotals) {
                            result.push({
                                type: 'group-total',
                                level: 2,
                                value: key2,
                                groupField: groupConfig.field2,
                                data: grouped2[key2]
                            });
                        }
                    });
                } else {
                    result.push(...grouped1[key1]);
                }

                if (groupConfig.showGroupTotals) {
                    result.push({
                        type: 'group-total',
                        level: 1,
                        value: key1,
                        groupField: groupConfig.field1,
                        data: grouped1[key1]
                    });
                }
            });

            if (groupConfig.showGrandTotal) {
                result.push({
                    type: 'grand-total',
                    data: data
                });
            }

            return result;
        }

        function applyAdvancedStyling(data, styleConfig) {
            // if (!styleConfig.enableColors) return data;

            return data.map((item, index) => {
                if (item.type) return item;

                const newItem = { ...item };

                if (index % 4 === 0) {
                    newItem._rowColor = '#f0f8ff';
                    newItem._rowHeight = 32;
                } else if (index % 4 === 2) {
                    newItem._rowColor = '#fff8f0';
                    newItem._rowHeight = 30;
                }

                if (item.preco > 500) {
                    newItem._cell_preco_color = '#ffebee';
                    newItem._cell_preco_textColor = '#c62828';
                    newItem._cell_total_color = '#ffebee';
                    newItem._cell_total_textColor = '#c62828';
                }

                if (item.quantidade > 80) {
                    newItem._cell_quantidade_color = '#e8f5e8';
                    newItem._cell_quantidade_textColor = '#2e7d32';
                }

                return newItem;
            });
        }
        // Agrupamento recursivo para N níveis otimizado para Tabulator
        // Agrupamento recursivo para N níveis otimizado para Tabulator

        // Agrupamento recursivo para N níveis - GENÉRICO para qualquer conjunto de colunas
        function groupDataMultiLevel(data, groupFields, allColumns = [], level = 0) {
            if (level >= groupFields.length || !data.length) {
                return data;
            }

            const currentField = groupFields[level];
            const grouped = {};

            // Agrupar por campo atual
            data.forEach(item => {
                // Ignorar itens que já são grupos
                if (item.type && (item.type === 'group-header' || item.type === 'group-total')) {
                    return;
                }

                const key = item[currentField] || 'Não Definido';
                if (!grouped[key]) {
                    grouped[key] = [];
                }
                grouped[key].push(item);
            });

            const result = [];
            const sortedGroups = Object.keys(grouped).sort();

            sortedGroups.forEach(key => {
                const groupItems = grouped[key];
                const firstItem = groupItems[0] || {};

                // Criar cabeçalho do grupo - GENÉRICO para qualquer coluna
                const groupHeader = {
                    type: 'group-header',
                    level: level,
                    value: key,
                    groupField: currentField,
                    // Copiar dinamicamente todas as propriedades do primeiro item
                    ...firstItem,
                    // Sobrescrever com propriedades específicas do grupo
                    _rowColor: level === 0 ? '#2c3e50' : (level === 1 ? '#3498db' : '#5dade2'),
                    _textColor: '#ffffff',
                    _rowHeight: 35,
                    nivel: level === 0 ? 'principal' : 'subgrupo',
                    // Garantir que o valor do campo de agrupamento seja o do grupo
                    [currentField]: key
                };

                // Para campos que não são o de agrupamento atual, manter vazio nos cabeçalhos
                groupFields.forEach((field, idx) => {
                    if (idx > level) {
                        groupHeader[field] = ''; // Campos de níveis inferiores ficam vazios
                    }
                });

                result.push(groupHeader);

                // Processar subgrupos recursivamente
                const subGrouped = groupDataMultiLevel(groupItems, groupFields, allColumns, level + 1);
                result.push(...subGrouped);

                // Criar total do grupo - GENÉRICO
                const groupTotal = {
                    type: 'group-total',
                    level: level,
                    value: key,
                    groupField: currentField,
                    data: groupItems,
                    // Copiar estrutura do primeiro item mas limpar dados numéricos
                    ...Object.fromEntries(
                        Object.entries(firstItem).map(([key, value]) => {
                            if (typeof value === 'number') {
                                return [key, '']; // Limpar valores numéricos
                            }
                            return [key, value];
                        })
                    ),
                    _rowColor: level === 0 ? '#34495e' : (level === 1 ? '#2980b9' : '#3498db'),
                    _textColor: '#ffffff',
                    _rowHeight: 32,
                    nivel: 'total',
                    // Garantir que o campo de agrupamento tenha o valor correto
                    [currentField]: key
                };

                result.push(groupTotal);
            });

            return result;
        }
        var GREPORT = null
        function generateReport() {
            const config = new MReportConfig().loadFromUI();

            const report = new MReport().setConfig(config);

            report.addText('RELATÓRIO PROFISSIONAL', {
                x: 50, y: 5, section: 'content',
                styleType: 'title', width: 400, height: 20
            });
            var subGroupFieds = ['categoria', 'subcategoria', 'marca'];

            // ===== DADOS COM MÚLTIPLOS NÍVEIS =====
            var multiLevelData = [
                // Eletrônicos → Smartphones
                { categoria: 'Eletrônicos', subcategoria: 'Smartphones', marca: 'Samsung', produto: 'Galaxy S23', quantidade: 15, preco: 2899.90, total: 43498.50 },
                { categoria: 'Eletrônicos', subcategoria: 'Smartphones', marca: 'Samsung', produto: 'Galaxy Z Flip', quantidade: 8, preco: 3899.90, total: 31199.20 },
                { categoria: 'Eletrônicos', subcategoria: 'Smartphones', marca: 'Apple', produto: 'iPhone 15 Pro', quantidade: 12, preco: 4599.90, total: 55198.80 },
                { categoria: 'Eletrônicos', subcategoria: 'Smartphones', marca: 'Apple', produto: 'iPhone 14', quantidade: 18, preco: 3299.90, total: 59398.20 },
                { categoria: 'Eletrônicos', subcategoria: 'Smartphones', marca: 'Xiaomi', produto: 'Mi 13', quantidade: 10, preco: 1999.90, total: 19999.00 },

                // Eletrônicos → Tablets
                { categoria: 'Eletrônicos', subcategoria: 'Tablets', marca: 'Samsung', produto: 'Tab S9', quantidade: 8, preco: 1899.90, total: 15199.20 },
                { categoria: 'Eletrônicos', subcategoria: 'Tablets', marca: 'Apple', produto: 'iPad Pro', quantidade: 6, preco: 4299.90, total: 25799.40 },
                { categoria: 'Eletrônicos', subcategoria: 'Tablets', marca: 'Apple', produto: 'iPad Air', quantidade: 10, preco: 2999.90, total: 29999.00 },
                { categoria: 'Eletrônicos', subcategoria: 'Tablets', marca: 'Lenovo', produto: 'Tab P12', quantidade: 12, preco: 1299.90, total: 15598.80 },

                // Eletrônicos → Notebooks
                { categoria: 'Eletrônicos', subcategoria: 'Notebooks', marca: 'Dell', produto: 'Inspiron 15', quantidade: 5, preco: 3299.90, total: 16499.50 },
                { categoria: 'Eletrônicos', subcategoria: 'Notebooks', marca: 'Dell', produto: 'XPS 13', quantidade: 3, preco: 5999.90, total: 17999.70 },
                { categoria: 'Eletrônicos', subcategoria: 'Notebooks', marca: 'Apple', produto: 'MacBook Air M2', quantidade: 4, preco: 5999.90, total: 23999.60 },
                { categoria: 'Eletrônicos', subcategoria: 'Notebooks', marca: 'Apple', produto: 'MacBook Pro 16', quantidade: 2, preco: 8999.90, total: 17999.80 },
                { categoria: 'Eletrônicos', subcategoria: 'Notebooks', marca: 'Lenovo', produto: 'ThinkPad X1', quantidade: 6, preco: 4599.90, total: 27599.40 },

                // Livros → Ficção
                { categoria: 'Livros', subcategoria: 'Ficção', genero: 'Ciência', produto: '1984 - George Orwell', quantidade: 22, preco: 39.90, total: 877.80 },
                { categoria: 'Livros', subcategoria: 'Ficção', genero: 'Ciência', produto: 'Admirável Mundo Novo', quantidade: 18, preco: 34.90, total: 628.20 },
                { categoria: 'Livros', subcategoria: 'Ficção', genero: 'Fantasia', produto: 'Harry Potter e a Pedra Filosofal', quantidade: 15, preco: 49.90, total: 748.50 },
                { categoria: 'Livros', subcategoria: 'Ficção', genero: 'Fantasia', produto: 'O Hobbit', quantidade: 20, preco: 37.90, total: 758.00 },
                { categoria: 'Livros', subcategoria: 'Ficção', genero: 'Romance', produto: 'Dom Casmurro', quantidade: 25, preco: 29.90, total: 747.50 },

                // Livros → Não-Ficção
                { categoria: 'Livros', subcategoria: 'Não-Ficção', genero: 'Biografia', produto: 'Steve Jobs - Walter Isaacson', quantidade: 12, preco: 59.90, total: 718.80 },
                { categoria: 'Livros', subcategoria: 'Não-Ficção', genero: 'Biografia', produto: 'Einstein - Sua Vida, Seu Universo', quantidade: 8, preco: 54.90, total: 439.20 },
                { categoria: 'Livros', subcategoria: 'Não-Ficção', genero: 'Autoajuda', produto: 'O Poder do Hábito', quantidade: 30, preco: 39.90, total: 1197.00 },
                { categoria: 'Livros', subcategoria: 'Não-Ficção', genero: 'Autoajuda', produto: 'Mais Esperto que o Diabo', quantidade: 25, preco: 34.90, total: 872.50 },

                // Roupas → Masculino
                { categoria: 'Roupas', subcategoria: 'Masculino', tipo: 'Camisetas', produto: 'Camiseta Básica Branca', quantidade: 50, preco: 29.90, total: 1495.00 },
                { categoria: 'Roupas', subcategoria: 'Masculino', tipo: 'Camisetas', produto: 'Camiseta Estampada', quantidade: 38, preco: 39.90, total: 1516.20 },
                { categoria: 'Roupas', subcategoria: 'Masculino', tipo: 'Calças', produto: 'Calça Jeans Slim', quantidade: 35, preco: 89.90, total: 3146.50 },
                { categoria: 'Roupas', subcategoria: 'Masculino', tipo: 'Calças', produto: 'Calça de Sarja', quantidade: 20, preco: 79.90, total: 1598.00 },

                // Roupas → Feminino
                { categoria: 'Roupas', subcategoria: 'Feminino', tipo: 'Vestidos', produto: 'Vestido Floral', quantidade: 22, preco: 129.90, total: 2857.80 },
                { categoria: 'Roupas', subcategoria: 'Feminino', tipo: 'Vestidos', produto: 'Vestido Longo', quantidade: 9, preco: 199.90, total: 1799.10 },
                { categoria: 'Roupas', subcategoria: 'Feminino', tipo: 'Blusas', produto: 'Blusa de Seda', quantidade: 14, preco: 159.90, total: 2238.60 },
                { categoria: 'Roupas', subcategoria: 'Feminino', tipo: 'Blusas', produto: 'Blusa Tricot', quantidade: 11, preco: 79.90, total: 878.90 },
                { categoria: 'Eletrônicos', subcategoria: 'Smartphones', marca: 'Samsung', produto: 'Galaxy S23', quantidade: 15, preco: 2899.90, total: 43498.50 },
                { categoria: 'Eletrônicos', subcategoria: 'Smartphones', marca: 'Samsung', produto: 'Galaxy Z Flip', quantidade: 8, preco: 3899.90, total: 31199.20 },
                { categoria: 'Eletrônicos', subcategoria: 'Smartphones', marca: 'Apple', produto: 'iPhone 15 Pro', quantidade: 12, preco: 4599.90, total: 55198.80 },
                { categoria: 'Eletrônicos', subcategoria: 'Smartphones', marca: 'Apple', produto: 'iPhone 14', quantidade: 18, preco: 3299.90, total: 59398.20 },
                { categoria: 'Eletrônicos', subcategoria: 'Smartphones', marca: 'Xiaomi', produto: 'Mi 13', quantidade: 10, preco: 1999.90, total: 19999.00 },

                // Eletrônicos → Tablets
                { categoria: 'Eletrônicos', subcategoria: 'Tablets', marca: 'Samsung', produto: 'Tab S9', quantidade: 8, preco: 1899.90, total: 15199.20 },
                { categoria: 'Eletrônicos', subcategoria: 'Tablets', marca: 'Apple', produto: 'iPad Pro', quantidade: 6, preco: 4299.90, total: 25799.40 },
                { categoria: 'Eletrônicos', subcategoria: 'Tablets', marca: 'Apple', produto: 'iPad Air', quantidade: 10, preco: 2999.90, total: 29999.00 },
                { categoria: 'Eletrônicos', subcategoria: 'Tablets', marca: 'Lenovo', produto: 'Tab P12', quantidade: 12, preco: 1299.90, total: 15598.80 },

                // Eletrônicos → Notebooks
                { categoria: 'Eletrônicos', subcategoria: 'Notebooks', marca: 'Dell', produto: 'Inspiron 15', quantidade: 5, preco: 3299.90, total: 16499.50 },
                { categoria: 'Eletrônicos', subcategoria: 'Notebooks', marca: 'Dell', produto: 'XPS 13', quantidade: 3, preco: 5999.90, total: 17999.70 },
                { categoria: 'Eletrônicos', subcategoria: 'Notebooks', marca: 'Apple', produto: 'MacBook Air M2', quantidade: 4, preco: 5999.90, total: 23999.60 },
                { categoria: 'Eletrônicos', subcategoria: 'Notebooks', marca: 'Apple', produto: 'MacBook Pro 16', quantidade: 2, preco: 8999.90, total: 17999.80 },
                { categoria: 'Eletrônicos', subcategoria: 'Notebooks', marca: 'Lenovo', produto: 'ThinkPad X1', quantidade: 6, preco: 4599.90, total: 27599.40 },

                // Livros → Ficção
                { categoria: 'Livros', subcategoria: 'Ficção', genero: 'Ciência', produto: '1984 - George Orwell', quantidade: 22, preco: 39.90, total: 877.80 },
                { categoria: 'Livros', subcategoria: 'Ficção', genero: 'Ciência', produto: 'Admirável Mundo Novo', quantidade: 18, preco: 34.90, total: 628.20 },
                { categoria: 'Livros', subcategoria: 'Ficção', genero: 'Fantasia', produto: 'Harry Potter e a Pedra Filosofal', quantidade: 15, preco: 49.90, total: 748.50 },
                { categoria: 'Livros', subcategoria: 'Ficção', genero: 'Fantasia', produto: 'O Hobbit', quantidade: 20, preco: 37.90, total: 758.00 },
                { categoria: 'Livros', subcategoria: 'Ficção', genero: 'Romance', produto: 'Dom Casmurro', quantidade: 25, preco: 29.90, total: 747.50 },

                // Livros → Não-Ficção
                { categoria: 'Livros', subcategoria: 'Não-Ficção', genero: 'Biografia', produto: 'Steve Jobs - Walter Isaacson', quantidade: 12, preco: 59.90, total: 718.80 },
                { categoria: 'Livros', subcategoria: 'Não-Ficção', genero: 'Biografia', produto: 'Einstein - Sua Vida, Seu Universo', quantidade: 8, preco: 54.90, total: 439.20 },
                { categoria: 'Livros', subcategoria: 'Não-Ficção', genero: 'Autoajuda', produto: 'O Poder do Hábito', quantidade: 30, preco: 39.90, total: 1197.00 },
                { categoria: 'Livros', subcategoria: 'Não-Ficção', genero: 'Autoajuda', produto: 'Mais Esperto que o Diabo', quantidade: 25, preco: 34.90, total: 872.50 },

                // Roupas → Masculino
                { categoria: 'Roupas', subcategoria: 'Masculino', tipo: 'Camisetas', produto: 'Camiseta Básica Branca', quantidade: 50, preco: 29.90, total: 1495.00 },
                { categoria: 'Roupas', subcategoria: 'Masculino', tipo: 'Camisetas', produto: 'Camiseta Estampada', quantidade: 38, preco: 39.90, total: 1516.20 },
                { categoria: 'Roupas', subcategoria: 'Masculino', tipo: 'Calças', produto: 'Calça Jeans Slim', quantidade: 35, preco: 89.90, total: 3146.50 },
                { categoria: 'Roupas', subcategoria: 'Masculino', tipo: 'Calças', produto: 'Calça de Sarja', quantidade: 20, preco: 79.90, total: 1598.00 },

                // Roupas → Feminino
                { categoria: 'Roupas', subcategoria: 'Feminino', tipo: 'Vestidos', produto: 'Vestido Floral', quantidade: 22, preco: 129.90, total: 2857.80 },
                { categoria: 'Roupas', subcategoria: 'Feminino', tipo: 'Vestidos', produto: 'Vestido Longo', quantidade: 9, preco: 199.90, total: 1799.10 },
                { categoria: 'Roupas', subcategoria: 'Feminino', tipo: 'Blusas', produto: 'Blusa de Seda', quantidade: 14, preco: 159.90, total: 2238.60 },
                { categoria: 'Roupas', subcategoria: 'Feminino', tipo: 'Blusas', produto: 'Blusa Tricot', quantidade: 11, preco: 79.90, total: 878.90 }
            ];


            var subGroupFields = ['categoria', 'subcategoria', 'marca'];
            var levelData = groupDataMultiLevel(multiLevelData, subGroupFieds, reportColumns);

            console.log("multiLevelData", multiLevelData)


            report.addTable(levelData, reportColumns, {
                x: 0, y: 350, section: 'content',
                width: 700, height: '100%'
            });

            report.addText('Confidencial - Uso Interno', {
                x: 250, y: 5, section: 'footer',
                width: 200, height: 25
            });

            report.generate('report-container');

            GREPORT = report;

        }

        // ===== INICIALIZAÇÃO =====
        $(document).ready(function () {
            // Configurar tabs


            generateReport();

            var state = PetiteVue.reactive({
                mreport: GREPORT
            });

            window.mreportAppState = state;

            PetiteVue.createApp(state).mount("#report-container");
        });

        // Utilitário para converter string CSS em objeto
        $.parseStyle = function (styleString) {
            const styleObj = {};
            const styles = styleString.split(';');

            styles.forEach(style => {
                if (style.trim()) {
                    const [property, value] = style.split(':');
                    if (property && value) {
                        const camelCaseProperty = property.trim().replace(/-([a-z])/g, function (g) {
                            return g[1].toUpperCase();
                        });
                        styleObj[camelCaseProperty] = value.trim();
                    }
                }
            });

            return styleObj;
        };
    </script>
</body>

</html>
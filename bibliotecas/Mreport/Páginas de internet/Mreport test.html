<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<style>
    /* Container com altura exata para A4 */
    .m-report-rendered-page {
        width: 794px;
        /* 210mm em 96dpi */
        height: 1123px;
        /* Altura exata para A4 (297mm) */
        background-color: white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
        /* Importante: impede que conteúdo extra escape */
        page-break-after: always;
    }

    .m-report-rendered-header {
        height: 90px;
        border-bottom: 1px solid #ddd;
        padding: 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        /* Impede que o header encolha */
    }

    .m-report-rendered-header-title {
        font-size: 20pt;
        font-weight: bold;
        color: #333;
    }

    .m-report-rendered-content {
        flex: 1;
        padding: 40px;
        overflow: hidden;
        /* Impede scrollbars */
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .m-report-rendered-content-title {
        font-size: 16pt;
        margin-bottom: 25px;
        color: #444;
    }

    .m-report-rendered-content-text {
        font-size: 11pt;
        line-height: 1.6;
        margin-bottom: 15px;
    }

    .m-report-rendered-content-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        margin-bottom: 15px;
    }

    .m-report-rendered-content-table th,
    .m-report-rendered-content-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    .m-report-rendered-content-table th {
        background-color: #f2f2f2;
    }

    .m-report-rendered-footer {
        height: 60px;
        background-color: #8d5252;
        border-top: 1px solid #ddd;
        padding: 15px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 10pt;
        color: white;
        flex-shrink: 0;
        /* Impede que o footer encolha */
    }

    .m-report-rendered-export-btn {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 14px;
        cursor: pointer;
        border-radius: 4px;
        margin-bottom: 20px;
        transition: background-color 0.3s;
    }

    .m-report-rendered-export-btn:hover {
        background-color: #45a049;
    }

    .report-object {
        position: absolute;
    }

    .object-content {
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    .continuation-info {
        font-size: 8px;
        color: #666;
        padding: 2px 5px;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
    }

    @media print {
        .m-report-rendered-page {
            box-shadow: none;
            margin: 0;
            page-break-after: always;
        }

        .m-report-rendered-export-btn {
            display: none;
        }
    }
</style>


<script src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Flatpickr Portuguese localization -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<script src="https://unpkg.com/petite-vue"></script>
<script src="https://cdn.jsdelivr.net/npm/alasql"></script>

<body>
    <div style="display: flex;align-items: center;justify-content: center;" id="reportRenderedContainer">
        <!-- As páginas serão geradas dinamicamente pelo MpageReport -->
    </div>
    <button class="m-report-rendered-export-btn" onclick="exportToPDF()">Exportar para PDF</button>
</body>

<script>
    // Classe principal para gerenciamento de páginas e quebra de elementos

    function forceJSONParse(data, defaultValue) {

        if (typeof data === 'string') {
            try {
                return JSON.parse(data);
            } catch (e) {
                return defaultValue;
            }
        }
        else {
            return data || defaultValue;
        }

    }
    function MpageReport(config) {
        var self = this;

        // Configurações
        this.config = config || {};
        this.pageWidth = this.config.pageWidth || 794;
        this.pageHeight = this.config.pageHeight || 1123;
        this.margins = this.config.margins || { top: 40, right: 40, bottom: 40, left: 40 };
        this.currentPage = null;
        this.pages = [];
        this.currentY = 0;

        // Áreas disponíveis por seção
        this.sectionHeights = {
            header: 90,
            content: 0,
            footer: 60
        };

        this.init();
    }

    MpageReport.prototype.init = function () {
        this.sectionHeights.content = this.pageHeight -
            this.sectionHeights.header -
            this.sectionHeights.footer -
            this.margins.top -
            this.margins.bottom;

        this.currentY = this.sectionHeights.header + this.margins.top;
    };

    MpageReport.prototype.createNewPage = function () {
        var newPage = {
            number: this.pages.length + 1,
            elements: [],
            sections: {
                header: [],
                content: [],
                footer: []
            },
            availableHeight: this.sectionHeights.content,
            currentY: this.sectionHeights.header + this.margins.top
        };

        this.pages.push(newPage);
        this.currentPage = newPage;
        return newPage;
    };

    MpageReport.prototype.calculateElementHeight = function (element, data) {
        var baseHeight = element.height || 60;

        if (element.tipo === "Tabela" && data && data.length > 0) {
            var config = forceJSONParse(element.configjson, {});
            var rowHeight = config.rowHeight || 30;
            var headerHeight = config.showHeader !== false ? 40 : 0;

            return Math.max(baseHeight, headerHeight + (data.length * rowHeight));
        }

        return baseHeight;
    };

    MpageReport.prototype.fitsInCurrentPage = function (elementHeight) {
        if (!this.currentPage) return false;

        var availableSpace = this.currentPage.availableHeight -
            (this.currentPage.currentY - (this.sectionHeights.header + this.margins.top));

        return elementHeight <= availableSpace;
    };

    MpageReport.prototype.addElement = function (element, data) {
        var elementHeight = this.calculateElementHeight(element, data);

        if (!this.currentPage || !this.fitsInCurrentPage(elementHeight)) {
            this.createNewPage();
        }

        if (element.tipo === "Tabela" && this.isBreakableElement(element)) {
            this.handleBreakableElement(element, data, elementHeight);
        } else {
            this.addSimpleElement(element, data, elementHeight);
        }
    };

    MpageReport.prototype.isBreakableElement = function (element) {
        return element.tipo === "Tabela";
    };

    MpageReport.prototype.handleBreakableElement = function (element, data, totalHeight) {
        var availableSpace = this.getAvailableSpace();

        if (totalHeight <= availableSpace) {
            this.addSimpleElement(element, data, totalHeight);
        } else {
            this.splitAndAddElement(element, data, totalHeight, availableSpace);
        }
    };

    MpageReport.prototype.getAvailableSpace = function () {
        if (!this.currentPage) return 0;

        return this.currentPage.availableHeight -
            (this.currentPage.currentY - (this.sectionHeights.header + this.margins.top));
    };

    MpageReport.prototype.addSimpleElement = function (element, data, height) {
        var pageElement = {
            element: element,
            data: data,
            height: height,
            y: this.currentPage.currentY,
            isPartial: false,
            partNumber: 1,
            totalParts: 1
        };

        this.currentPage.elements.push(pageElement);
        this.currentPage.sections.content.push(pageElement);
        this.currentPage.currentY += height;
    };

    MpageReport.prototype.splitAndAddElement = function (element, data, totalHeight, availableSpace) {
        if (element.tipo === "Tabela") {
            this.splitTableElement(element, data, totalHeight, availableSpace);
        }
    };

    MpageReport.prototype.splitTableElement = function (element, data, totalHeight, availableSpace) {
        var config = forceJSONParse(element.configjson, {});
        var rowHeight = config.rowHeight || 30;
        var headerHeight = config.showHeader !== false ? 40 : 0;

        var availableRowsHeight = availableSpace - headerHeight;
        var rowsThatFit = Math.floor(availableRowsHeight / rowHeight);

        if (rowsThatFit <= 0) {
            this.createNewPage();
            this.splitTableElement(element, data, totalHeight, this.getAvailableSpace());
            return;
        }

        var firstPartData = data.slice(0, rowsThatFit);
        var remainingData = data.slice(rowsThatFit);

        var firstPartHeight = headerHeight + (firstPartData.length * rowHeight);

        var firstPartElement = {
            element: element,
            data: firstPartData,
            height: firstPartHeight,
            y: this.currentPage.currentY,
            isPartial: true,
            partNumber: 1,
            totalParts: Math.ceil(data.length / rowsThatFit),
            isFirstPart: true
        };

        this.currentPage.elements.push(firstPartElement);
        this.currentPage.sections.content.push(firstPartElement);
        this.currentPage.currentY += firstPartHeight;

        if (remainingData.length > 0) {
            this.createNewPage();

            var remainingPartElement = {
                element: element,
                data: remainingData,
                height: headerHeight + (remainingData.length * rowHeight),
                y: this.currentPage.currentY,
                isPartial: true,
                partNumber: 2,
                totalParts: firstPartElement.totalParts,
                isContinuation: true
            };

            this.currentPage.elements.push(remainingPartElement);
            this.currentPage.sections.content.push(remainingPartElement);
            this.currentPage.currentY += remainingPartElement.height;
        }
    };

    MpageReport.prototype.renderPages = function (containerSelector) {
        var self = this;
        var container = $(containerSelector);
        container.empty();

        this.pages.forEach(function (page, index) {
            var pageElement = self.renderSinglePage(page, index);
            container.append(pageElement);
        });
    };

    MpageReport.prototype.renderSinglePage = function (page, pageIndex) {
        var self = this;
        var pageDiv = $('<div class="m-report-rendered-page"></div>');

        var header = $('<header class="m-report-rendered-header"></header>');
        page.sections.header.forEach(function (headerElement) {
            header.append(self.renderElement(headerElement, pageIndex));
        });
        pageDiv.append(header);

        var content = $('<main class="m-report-rendered-content"></main>');
        page.sections.content.forEach(function (contentElement) {
            content.append(self.renderElement(contentElement, pageIndex));
        });
        pageDiv.append(content);

        var footer = $('<footer class="m-report-rendered-footer"></footer>');
        var pageInfo = {
            element: {
                tipo: "Texto",
                configjson: JSON.stringify({
                    staticText: "Página " + page.number + " de " + self.pages.length,
                    textFormat: { textAlign: "center", fontSize: 10 },
                    colors: { textColor: "#ffffff" }
                })
            },
            data: []
        };
        footer.append(self.renderElement(pageInfo, pageIndex));

        page.sections.footer.forEach(function (footerElement) {
            footer.append(self.renderElement(footerElement, pageIndex));
        });
        pageDiv.append(footer);

        return pageDiv;
    };

    MpageReport.prototype.renderElement = function (pageElement, pageIndex) {
        var element = pageElement.element;
        var elementDiv = $('<div class="report-object"></div>');

        elementDiv.css({
            transform: "translate3d(" + element.x + "px, " + pageElement.y + "px, 0)",
            width: element.width + "px",
            height: pageElement.height + "px",
            position: "absolute"
        });

        if (pageElement.isPartial) {
            var continuationInfo = "";
            if (pageElement.isFirstPart) {
                continuationInfo = "<div class='continuation-info'>continua...</div>";
            } else if (pageElement.isContinuation) {
                continuationInfo = "<div class='continuation-info'>...continuação</div>";
            }

            elementDiv.append(continuationInfo);
        }

        var contentId = "object-page-" + pageIndex + "-" + element.mreportobjectstamp;
        elementDiv.append('<div id="' + contentId + '" class="object-content"></div>');

        this.renderElementContent(contentId, element, pageElement.data, pageElement);

        return elementDiv;
    };

    MpageReport.prototype.renderElementContent = function (containerId, element, data, pageElement) {
        var selector = "#" + containerId;

        if (element.tipo === "Tabela") {
            this.renderTableElement(selector, element, data, pageElement);
        } else {
            if (element.renderOnPage) {
                element.renderOnPage(selector, true);
            }
        }
    };

    MpageReport.prototype.renderTableElement = function (selector, element, data, pageElement) {
        var config = forceJSONParse(element.configjson, {});

        if (pageElement.isPartial) {
            config.showHeader = pageElement.isFirstPart || !pageElement.isContinuation;
            config.height = pageElement.height + "px";
        }

        var originalConfig = element.configjson;
        element.configjson = JSON.stringify(config);

        if (element.renderOnPage) {
            element.renderOnPage(selector, true);
        }

        element.configjson = originalConfig;
    };

    MpageReport.prototype.processReportObjects = function (reportObjects, dataSources) {
        var self = this;

        this.pages = [];
        this.currentPage = null;

        var sortedObjects = reportObjects.sort(function (a, b) {
            var sectionOrder = { header: 1, content: 2, footer: 3 };
            if (a.section !== b.section) {
                return sectionOrder[a.section] - sectionOrder[b.section];
            }
            return a.y - b.y;
        });

        sortedObjects.forEach(function (obj) {
            var data = self.getDataForObject(obj, dataSources);
            self.addElement(obj, data);
        });

        return this.pages;
    };

    MpageReport.prototype.getDataForObject = function (obj, dataSources) {
        if (obj.tipo === "Tabela" && obj.objectQuery) {
            try {
                return alasql(obj.objectQuery);
            } catch (e) {
                console.error("Erro ao executar query para objeto:", e);
                return [];
            }
        }
        return [];
    };

    MpageReport.prototype.exportToPDF = function () {
        console.log("Exportando", this.pages.length, "páginas para PDF");
        window.print();
    };

    var GReportInstance = new MReport({});

    $(document).ready(function () {
        GReportInstance = new MReport({ codigo: "RELATORIOACTIVO" });
        GReportInstance.render();
    });

    function MReport(data) {
        var mreportThis = this;
        this.codigo = data.codigo || '';
        this.descricao = data.descricao || '';
        this.GMReportFilters = [new MReportFilter({})];
        this.config = data.config || [];
        this.GMReportFilters = [];
        this.GMRelatorioDeleteRecords = [];
        this.GMRelatorioStamp = "";
        this.GMReportConfig = new MReportConfig({});
        this.GMReportObjects = [new MReportObject({})];
        this.GMReportObjects = [];
        this.GMReportFontes = [new MReportFonte({})];
        this.GMReportFontes = [];
        this.pageManager = null;

        function MReportObject(data) {
            var self = this;
            this.mreportobjectstamp = data.mreportobjectstamp || "";
            this.mreportstamp = data.mreportstamp || mreportThis.GMRelatorioStamp;
            this.codigo = data.codigo || '';
            this.tipo = data.tipo || 'text';
            this.tamanho = data.tamanho || 6;
            this.ordem = data.ordem || 0;
            this.categoria = data.categoria || 'basic';
            this.expressaoobjecto = data.expressaoobjecto || '';
            this.configjson = data.configjson || '{}';
            this.queryconfigjson = data.queryconfigjson || '{}';
            this.objectQuery = data.objectQuery || '';
            this.section = data.section || 'content';
            this.x = data.x || 0;
            this.y = data.y || 0;
            this.width = data.width || 200;
            this.height = data.height || 60;
            this.table = "MReportObject";
            this.idfield = "mreportobjectstamp";
            this.descricao = data.descricao || 'Novo Objeto';
            this.icon = data.icon || 'fas fa-question';
            this.content = data.content || '';
            this.selected = data.selected || false;
            this.dataSource = data.dataSource || null;
            this.bold = data.bold || false;
            this.italic = data.italic || false;
            this.textColor = data.textColor || '#000000';
            this.backgroundColor = data.backgroundColor || '#ffffff';
            this.config = {};
            this.queryConfig = {};
            this.objectEditorConfig = data.objectEditorConfig || {};
            this.config = forceJSONParse(this.configjson, {});
            this.queryConfig = forceJSONParse(this.queryconfigjson, {});
        }

        MReportObject.prototype.renderOnPage = function (selector, clearContainer) {
            var self = this;
            if (clearContainer) {
                $(selector).empty();
            }
            self.objectEditorConfig.renderObject({
                containerSelector: selector,
                itemObject: self,
                config: self.config,
                data: []
            })
        }

        MReportObject.prototype.setUIData = function () {
            var self = this;
            var tiposObjectos = getTiposObjectoConfig();
            var tipoObjecto = tiposObjectos.find(function (t) {
                return t.tipo === self.tipo;
            });
            if (tipoObjecto) {
                self.icon = tipoObjecto.icon;
                self.descricao = tipoObjecto.descricao;
                self.objectEditorConfig = tipoObjecto;
            }
        }

        function MReportFilter(data) {
            var self = this;
            this.mreportfilterstamp = data.mreportfilterstamp || "";
            this.mreportstamp = data.mreportstamp || mreportThis.GMRelatorioStamp;
            this.codigo = data.codigo || 'Filtro';
            this.descricao = data.descricao || '';
            this.tipo = data.tipo || 'text';
            this.campooption = data.campooption || '';
            this.eventochange = data.eventochange || false;
            this.expressaochange = data.expressaochange || '';
            this.campovalor = data.campovalor || '';
            this.tamanho = data.tamanho || 6;
            this.expressaolistagem = data.expressaolistagem || '';
            this.expressaojslistagem = data.expressaojslistagem || '';
            this.valordefeito = data.valordefeito || '';
            this.ordem = data.ordem || 0;
            this.objectsUIFormConfig = data.objectsUIFormConfig || [];
            this.localsource = data.localsource || "";
            this.idfield = data.idfield || "mreportfilterstamp";
            this.table = "MReportFilter";
        }

        MReportFilter.prototype.setUIFormConfig = function () {
            var UIFormConfig = getmreportFilterUIObjectFormConfigAndSourceValues();
            this.objectsUIFormConfig = UIFormConfig.objectsUIFormConfig;
            this.localsource = UIFormConfig.localsource;
            this.idfield = UIFormConfig.idField;
        }

        function getmreportFilterUIObjectFormConfigAndSourceValues() {
            var objectsUIFormConfig = [
                new UIObjectFormConfig({ colSize: 4, campo: "codigo", tipo: "text", titulo: "Código", classes: "form-control input-source-form input-sm", contentType: "input" }),
                new UIObjectFormConfig({ colSize: 4, campo: "descricao", tipo: "text", titulo: "Descrição", classes: "form-control input-source-form input-sm", contentType: "input" }),
                new UIObjectFormConfig({ colSize: 4, campo: "ordem", tipo: "digit", titulo: "Ordem", classes: "form-control input-source-form input-sm", contentType: "input" }),
                new UIObjectFormConfig({
                    colSize: 12,
                    campo: "tipo",
                    tipo: "select",
                    titulo: "Tipo",
                    fieldToOption: "option",
                    contentType: "select",
                    fieldToValue: "value",
                    classes: "form-control input-source-form  input-sm ",
                    selectValues: [
                        { option: "Texto", value: "text" },
                        { option: "Radio", value: "radio" },
                        { option: "Lógico", value: "logic" },
                        { option: "Data", value: "date" },
                        { option: "Número", value: "number" },
                        { option: "Lista", value: "list" },
                        { option: "Multipla escolha", value: "multiselect" }
                    ]
                }),
                new UIObjectFormConfig({ colSize: 6, campo: "campooption", tipo: "text", titulo: "Campo de Opção", classes: "form-control input-source-form input-sm", contentType: "input" }),
                new UIObjectFormConfig({ colSize: 6, campo: "campovalor", tipo: "text", titulo: "Campo de Valor", classes: "form-control input-source-form input-sm", contentType: "input" }),
                new UIObjectFormConfig({ colSize: 4, campo: "tamanho", tipo: "digit", titulo: "Tamanho", classes: "form-control input-source-form input-sm", contentType: "input" }),
                new UIObjectFormConfig({ colSize: 12, style: "width: 100%; height: 200px;", campo: "expressaolistagem", tipo: "div", cols: 90, rows: 90, titulo: "Expressão de Listagem", classes: "input-source-form m-editor", contentType: "div" }),
                new UIObjectFormConfig({ colSize: 12, style: "width: 100%; height: 200px;", campo: "expressaojslistagem", tipo: "div", cols: 90, rows: 90, titulo: "Expressão de Listagem JS", classes: "input-source-form m-editor", contentType: "div" }),
                new UIObjectFormConfig({ colSize: 12, style: "width: 100%; height: 200px;", campo: "valordefeito", tipo: "div", cols: 90, rows: 90, titulo: "Valor por Defeito", classes: "input-source-form m-editor", contentType: "div" }),
                new UIObjectFormConfig({ colSize: 4, campo: "eventochange", tipo: "checkbox", titulo: "Tem evento change", classes: "input-source-form", contentType: "input" }),
                new UIObjectFormConfig({ colSize: 12, style: "width: 100%; height: 200px;", campo: "expressaochange", tipo: "div", cols: 90, rows: 90, titulo: "Expressão de Change", classes: "input-source-form m-editor", contentType: "div" }),
            ];
            return { objectsUIFormConfig: objectsUIFormConfig, localsource: "GMReportFilters", idField: "mreportfilterstamp" };
        }

        function UIObjectFormConfig(data) {
            this.campo = data.campo || "";
            this.tipo = data.tipo || "";
            this.titulo = data.titulo || "";
            this.classes = data.classes || "";
            this.customData = data.customData || "";
            this.style = data.style || "";
            this.selectValues = data.selectValues || [];
            this.colSize = data.colSize || "4";
            this.fieldToOption = data.fieldToOption || "";
            this.fieldToValue = data.fieldToValue || "";
            this.contentType = data.contentType || "input";
        }

        function MReportFonte(data) {
            var self = this;
            this.mreportfonstestamp = data.mreportfonstestamp || "";
            this.mreportstamp = data.mreportstamp || mreportThis.GMRelatorioStamp;
            this.codigo = data.codigo || "Fonte-";
            this.descricao = data.descricao || '';
            this.tipo = data.tipo || 'query';
            this.expressaolistagem = data.expressaolistagem || '';
            this.expressaojslistagem = data.expressaojslistagem || '';
            this.ordem = (data.ordem || 0);
            this.schemajson = data.schemajson || '[]';
            this.lastResultscached = data.lastResultscached || '[]';
            this.schema = [];
            this.lastResults = [];
            this.lastResults = forceJSONParse(this.lastResultscached, []);
            this.schema = forceJSONParse(this.schemajson, []);
            this.testData = data.testData || [];
            this.lastExecuted = data.lastExecuted || [];
            this.isActive = data.isActive !== undefined ? data.isActive : true;
            this.schemaQueryEditor = "";
            this.objectsUIFormConfig = data.objectsUIFormConfig || [];
            this.localsource = data.localsource || "";
            this.idfield = data.idfield || "mreportfonstestamp";
            this.table = "MReportFonte";
        }

        MReportFonte.prototype.setTupDataOnLocalDb = function (data) {
            var tableSchema = extractLocalDbSchema(this.lastResults[0]);
            setTupDataOnLocalDb("MReportDB", this.codigo, tableSchema, this.lastResults, this.mreportfonstestamp);
        }

        MReportFonte.prototype.setUIFormConfig = function () {
            var UIFormConfig = getMReportFonteUIObjectFormConfigAndSourceValues();
            this.objectsUIFormConfig = UIFormConfig.objectsUIFormConfig;
            this.localsource = UIFormConfig.localsource;
            this.idfield = UIFormConfig.idField;
        }

        function getMReportFonteUIObjectFormConfigAndSourceValues() {
            var objectsUIFormConfig = [
                new UIObjectFormConfig({ colSize: 4, campo: "codigo", tipo: "text", titulo: "Código", classes: "form-control input-source-form input-sm", contentType: "input" }),
                new UIObjectFormConfig({ colSize: 4, campo: "descricao", tipo: "text", titulo: "Descrição", classes: "form-control input-source-form input-sm", contentType: "input" }),
                new UIObjectFormConfig({ colSize: 4, campo: "ordem", tipo: "digit", titulo: "Ordem", classes: "form-control input-source-form input-sm", contentType: "input" }),
                new UIObjectFormConfig({
                    colSize: 12,
                    campo: "tipo",
                    tipo: "select",
                    titulo: "Tipo",
                    fieldToOption: "option",
                    contentType: "select",
                    fieldToValue: "value",
                    classes: "form-control input-source-form  input-sm ",
                    selectValues: [
                        { option: "Query SQL", value: "query" }
                    ]
                }),
                new UIObjectFormConfig({ customData: " v-on:keyup='changeExpressaoDbListagemAndHandleFilters()'", colSize: 12, style: "width: 100%; height: 200px;", campo: "expressaolistagem", tipo: "div", cols: 90, rows: 90, titulo: "Expressão de Listagem", classes: "input-source-form m-editor", contentType: "div" }),
                new UIObjectFormConfig({ colSize: 12, style: "width: 100%; height: 200px;", campo: "schemaQueryEditor", tipo: "div", cols: 90, rows: 90, titulo: "", classes: "input-source-form", contentType: "div" }),
                new UIObjectFormConfig({ colSize: 12, style: "width: 100%; height: 200px;", campo: "expressaojslistagem", tipo: "div", cols: 90, rows: 90, titulo: "Expressão de Listagem JS", classes: "input-source-form m-editor ", contentType: "div" })
            ];
            return { objectsUIFormConfig: objectsUIFormConfig, localsource: "GMReportFontes", idField: "mreportfonstestamp" };
        }

        MReportFonte.prototype.stringifyJSONFields = function () {
            var data = this;
            data.schemajson = JSON.stringify(data.schema || []);
            data.lastResultscached = JSON.stringify(data.lastResults || []);
            return data;
        }

        function forceJSONParse(data, defaultValue) {
            if (typeof data === 'string') {
                try {
                    return JSON.parse(data);
                } catch (e) {
                    return defaultValue;
                }
            }
            else {
                return data || defaultValue;
            }
        }

        function MReportConfig(data) {
            this.codigo = data.codigo || '';
            this.descricao = data.descricao || '';
            this.orientation = data.orientation || 'portrait';
            this.u_mreportstamp = data.u_mreportstamp || '';
            this.pagesize = data.pagesize || 'A4';
            this.margins = data.margins || { top: 20, right: 20, bottom: 20, left: 20 };
            this.sections = Array.isArray(data.sections) ? data.sections.map(function (s) {
                return new ReportSection(s);
            }) : [
                new ReportSection({ type: 'header', height: 100, width: 800, name: "Cabeçalho" }),
                new ReportSection({ type: 'content', height: 400, width: 800, name: "Conteúdo" }),
                new ReportSection({ type: 'footer', height: 50, width: 800, name: "Rodapé" })
            ];
        }

        MReportConfig.prototype.toJSONString = function () {
            return JSON.stringify(this);
        }

        function ReportSection(data) {
            this.type = data.type || 'header';
            this.name = data.name || "Cabeçalho";
            this.height = data.height || 100;
            this.width = data.width || 800;
        }

        this.render = function () {
            initConfiguracaoMReport({ codigo: mreportThis.codigo });
        }

        function fetchDadosMreport(config, dados) {
            var filters = dados.filters || [];
            var fontes = dados.fontes || [];
            var objects = dados.objects || [];
            var reportData = dados.report[0] || {};
            var reportConfig = {};

            try {
                reportConfig = JSON.parse(reportData.reportconfig) || {};
                reportConfig.u_mreportstamp = reportData.u_mreportstamp || '';
                reportConfig.codigo = reportData.codigo || '';
                reportConfig.descricao = reportData.descricao || '';
                mreportThis.GMReportConfig.u_mreportstamp = reportData.u_mreportstamp || '';
                mreportThis.GMRelatorioStamp = data.u_mreportstamp || '';
            } catch (error) {
                console.error("Erro ao parsear report config:", error);
            }

            mreportThis.GMReportConfig = new MReportConfig(reportConfig);
            mreportThis.GMReportFilters = filters.map(function (f) {
                var newFilter = new MReportFilter(f);
                newFilter.setUIFormConfig();
                return newFilter;
            });

            mreportThis.GMReportFontes = fontes.map(function (f) {
                var newFonte = new MReportFonte(f);
                newFonte.setUIFormConfig();
                newFonte.setTupDataOnLocalDb();
                return newFonte;
            });

            mreportThis.GMReportObjects = objects.map(function (o) {
                var newObject = new MReportObject(o);
                newObject.setUIData();
                return newObject;
            });
        }

        function initConfiguracaoMReport(data) {
            if (!data) {
                throw new Error("Dados inválidos para inicializar MReportConfig");
            }

            mreportThis.GMReportConfig = new MReportConfig({});

            $.ajax({
                type: "POST",
                url: "../programs/gensel.aspx?cscript=getconfiguracaomreport",
                async: false,
                data: {
                    '__EVENTARGUMENT': JSON.stringify([{ codigo: data.codigo }]),
                },
                success: function (response) {
                    var errorMessage = "ao trazer resultados da configuração do m report";
                    try {
                        if (response.cod != "0000") {
                            console.log("Erro " + errorMessage, response);
                            return false;
                        }
                        mreportThis.config = response.data;
                        fetchDadosMreport({}, response.data);

                        // Inicializar o gerenciador de páginas após carregar os dados
                        setTimeout(function () {
                            mreportThis.pageManager = new MpageReport({
                                pageWidth: 794,
                                pageHeight: 1123,
                                margins: { top: 40, right: 40, bottom: 40, left: 40 }
                            });

                            // Processar objetos e renderizar páginas
                            var pages = mreportThis.pageManager.processReportObjects(
                                mreportThis.GMReportObjects,
                                mreportThis.GMReportFontes
                            );

                            mreportThis.pageManager.renderPages('#reportRenderedContainer');
                        }, 100);
                    } catch (error) {
                        console.log("Erro interno " + errorMessage, error);
                    }
                }
            });
        }
    }
</script>

</html>
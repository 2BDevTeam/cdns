<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>

<script src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<style>
    .snapshot:hover,
    .celula:hover {
        cursor: pointer;
    }

    .celula:hover {
        text-decoration: underline;
    }


    form[action*="./ewpview.aspx?codigo=mdash"] #fieldsAndOptionsZone,
    form[action*="./ewpview.aspx?codigo=catalogo-"] #fieldsAndOptionsZone {
        background: none !important;
        box-shadow: none !important;
    }

    form[action*="./ewpview.aspx?codigo=mdash"] #optionsFields,
    form[action*="./ewpview.aspx?codigo=mdash"] .headerZone,
    form[action*="./ewpview.aspx?codigo=catalogo-"] #optionsFields,
    form[action*="./ewpview.aspx?codigo=catalogo-"] .headerZone {
        display: none;
    }


    .m-dash-header {
        display: flex;
        margin-bottom: 30px;
        background: #FFF;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, .08);
    }

    .m-dash-body {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .m-dash-header h1 {
        margin: 0;
        font-weight: bold;
        color: #626e78 !important;
    }

    .m-dash-filter {
        background: #FFF;
        -webkit-box-shadow: 0 4px 8px rgba(0, 0, 0, .08);
        -moz-box-shadow: 0 4px 8px rgba(0, 0, 0, .08);
        box-shadow: 0 4px 8px rgba(0, 0, 0, .08);
        border-radius: 12px;
        padding: 30px;
    }

    .m-dash-filter-btn-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .m-dash-btn-filter {
        display: flex;
        justify-content: space-between;
        gap: 5px;
    }

    .m-dash-data-headers {
        background: #FFF;
        -webkit-box-shadow: 0 4px 8px rgba(0, 0, 0, .08);
        -moz-box-shadow: 0 4px 8px rgba(0, 0, 0, .08);
        box-shadow: 0 4px 8px rgba(0, 0, 0, .08);
        border-radius: 12px;
        padding: 30px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        font-size: 0.9em;
    }

    .m-dash-main {
        display: flex;
        flex-direction: column;
        gap: 20px;
        flex-grow: 1;
    }


    .stats-card-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
    }

    .stats-card {
        background-color: #efefef;
        padding: 15px;
        border-radius: 5px;
    }

    .stats-card-grid {
        display: grid;
        grid-template-columns: 1fr;
    }

    .stats-card-chart {
        height: 300px;
    }

    .stats-card-value-container {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .stats-card-value {
        color: #999999;
    }

    .stats-card-label {
        font-size: 0.9em;
        font-weight: bold;
    }



    .m-dash-item {
        background: #FFF;
        -webkit-box-shadow: 0 4px 8px rgba(0, 0, 0, .08);
        -moz-box-shadow: 0 4px 8px rgba(0, 0, 0, .08);
        box-shadow: 0 4px 8px rgba(0, 0, 0, .08);
        border-radius: 12px;
        padding: 30px;
        width: 100%;
        overflow-x: auto;
    }

    .m-dash-item.snapshot {
        padding: 20px;
    }

    .m-dash-item h1 {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 15px;
    }

    .m-dash-charts {
        display: flex;
        flex-direction: column;
        gap: 20px;
        justify-content: space-between;
    }

    .m-dash-table {
        font-size: 0.9em;
        overflow-x: auto;
        max-height: 400px;
    }

    .m-dash-table table {
        width: 100%;
    }

    .m-dash-item-text {
        color: #626e78;
    }

    .m-dash-filter-item {
        color: #626e78;
    }

    @media screen and (min-width: 768px) {
        .stats-card-container {
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stats-card-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media screen and (min-width: 1024px) {
        .m-dash-body {
            flex-direction: row;
        }

        .m-dash-data-headers {
            flex-direction: row;
        }

        .m-dash-filter {
            min-width: 275px;
            max-width: 275px;
        }

        .m-dash-charts {
            flex-direction: row;
        }

        .stats-card-container {
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 30px;
        }
    }
</style>


<body>

    <div id="mdash" class="mdash">

        <div class="m-dash-header">
            <h1>{{ mdash.dashboardconfig.descricao }}</h1>
        </div>

        <div class="m-dash-body">

            <div v-if="mdash.filters.length >0" class="m-dash-filter">

                <div class="m-dash-filter-btn-group">

                    <div class="m-dash-btn-filter">
                        <p class="m-dash-item-text">Refrescar</p>
                        <button type='button' id='btn-refrescar-filtro'
                            class='btn btn-default btn-sm glyphicon glyphicon-refresh filtro'>
                        </button>
                    </div>

                </div>

                <div class="m-dash-dynamic-filters">
                    <div v-for="filter in mdash.filters" :key="filter.mdashfilterstamp" class="m-dash-filter-item">
                        <label class="m-dash-filter-item" :for="filter.codigo">{{ filter.descricao }}</label>

                        <!-- text -->
                        <input @change="updateFilter(filter,$event)" v-if="filter.tipo === 'text'" type="text"
                            class="form-control input-sm input-mdash-filter" :id="filter.codigo"
                            v-model="mdash.filterValues[filter.codigo]" />

                        <!-- digit -->
                        <input @change="updateFilter(filter,$event)" v-else-if="filter.tipo === 'digit'" type="text"
                            class="form-control input-sm input-mdash-filter" :id="filter.codigo"
                            v-model="mdash.filterValues[filter.codigo]" />

                        <!-- list -->
                        <select @change="updateFilter(filter,$event)" v-else-if="filter.tipo === 'list'"
                            class="form-control select-mdash-filter input-mdash-filter" :id="filter.codigo"
                            v-model="mdash.filterValues[filter.codigo]">
                            <option v-for="opt in getOptions(filter)" :value="opt[filter.campovalor]">
                                {{ opt[filter.campooption] }}
                            </option>
                        </select>

                        <!-- logic -->
                        <input @change="updateFilter(filter,$event)" v-else-if="filter.tipo === 'logic'" type="checkbox"
                            class="form-check-input" :id="filter.codigo" v-model="mdash.filterValues[filter.codigo]" />

                        <!-- fallback -->
                        <input @change="updateFilter(filter,$event)" v-else type="text"
                            class="form-control input-sm input-mdash-filter" :id="filter.codigo"
                            v-model="mdash.filterValues[filter.codigo]" />
                    </div>
                </div>

                <div class="m-dash-dynamic-filters">

                </div>

            </div>

            <div class="m-dash-main">
                <div v-for="container in mdash.containers" :key="container.mdashcontainerstamp"
                    :class="[`col-md-${container.tamanho}`, `col-sm-${container.tamanho}`, `col-lg-${container.tamanho}`]">

                    <div v-if="container.titulo.length > 0" style="margin-bottom: 0.8em;" class="col-md-12 pull-left">
                        <h1 class="m-dash-item-text">{{ container.titulo }}</h1>
                        <hr>
                    </div>

                    <!-- Aqui usamos os grupos de rows -->
                    <div v-for="(rowGroup, rowIndex) in getRowGroups(container.mdashcontainerstamp)"
                        :key="'row-' + rowIndex" class="row" style="margin-bottom: 0.8em;">

                        <div v-for="item in rowGroup.items" :key="item.mdashcontaineritemstamp"
                            :id="item.mdashcontaineritemstamp" :class="['m-dash-render-area', 
                          `col-md-${item.tamanho}`, 
                          `col-sm-${item.tamanho}`, 
                          `col-lg-${item.tamanho}`]">
                        </div>
                    </div>

                </div>
            </div>

        </div>


    </div>

</body>

<script src="https://unpkg.com/petite-vue"></script>
<script>

    function buildAlert(alertClass, alertText) {
        var alerta = ""
        alerta += "<div  class='alert custom-alert " + alertClass + "'>"
        alerta += "  <strong>Atenção!</strong> " + alertText
        alerta += "</div>"

        return alerta
    }

    function groupItemsByRows(containerItems, maxRowSize = 12) {
        var rows = [];
        var currentRow = [];
        var currentRowSize = 0;

        containerItems.forEach(function (item) {
            var itemSize = parseInt(item.tamanho) || 12;

            // Se adicionar este item ultrapassar o tamanho máximo da row
            if (currentRowSize + itemSize > maxRowSize) {
                // Finaliza a row atual (se não estiver vazia)
                if (currentRow.length > 0) {
                    rows.push({
                        items: currentRow,
                        totalSize: currentRowSize
                    });
                }

                // Inicia uma nova row
                currentRow = [item];
                currentRowSize = itemSize;
            } else {
                // Adiciona o item à row atual
                currentRow.push(item);
                currentRowSize += itemSize;
            }
        });

        // Adiciona a última row se não estiver vazia
        if (currentRow.length > 0) {
            rows.push({
                items: currentRow,
                totalSize: currentRowSize
            });
        }

        return rows;
    }

    function generateStandardCard(cardData) {

        return `<div class="m-dash-item">
                    <h4 class="m-dash-item-text">${cardData.titulo || "Sem título"}</h4>
                    
                        ${cardData.bodyContent}
                    
                </div>`;


    }

    function generateDashCardHTML(cardData) {
        var cardHTML = '<div id="' + (cardData.id || '') + '" class="dashcard">';
        // Header
        cardHTML += '<div class="dashcard-header dashcard-header-' + (cardData.type || "primary") + '">';
        cardHTML += '<span class="dashcard-title">' + (cardData.title || "") + '</span>';
        cardHTML += '</div>';
        // Body
        cardHTML += '<div class="dashcard-body">';
        cardHTML += (cardData.bodyContent || "");
        cardHTML += '</div>';
        cardHTML += '</div>';
        return cardHTML.trim();
    }


    function MdashRendConfig(data) {

        this.codigo = data.codigo || "";
        this.descricao = data.descricao || "";
        this.categoria = data.categoria || "";
        this.dashboardstamp = data.dashboardstamp || "";
        this.temfiltro = data.temfiltro || false;

    }

    function Mdash(data) {

        var globalThis = this;

        this.GMDashStamp = data.GMDashStamp || ""
        this.GMDashRendContainers = [];
        this.GMDashRendContainerItems = [];
        this.GMDashRendFilters = [];
        this.dashboardconfig = new MdashRendConfig(data.dashboardconfig) || new MdashRendConfig({});

        this.filters = Array.isArray(data.filters) ? data.filters.map(function (filter) {
            return new MdashRendFilter(filter);
        }) : [];
        this.filterValues = data.filterValues || {};

        this.containers = Array.isArray(data.containers) ? data.containers.map(function (container) {
            return new MdashRendContainer(container);
        }) : [];

        this.containerItems = Array.isArray(data.containerItems) ? data.containerItems.map(function (item) {
            return new MdashContainerItem(item);
        }) : [];

        this.reactiveInstance = null;


        function MdashRendFilter(data) {

            this.mdashfilterstamp = data.mdashfilterstamp || generateUUID();
            this.dashboardstamp = data.dashboardstamp || GMDashStamp;
            this.codigo = data.codigo || "";
            this.descricao = data.descricao || "";
            this.tipo = data.tipo || "text";
            this.tamanho = data.tamanho || 4;
            this.campooption = data.campooption || "";
            this.campovalor = data.campovalor || "";
            this.expressaolistagem = data.expressaolistagem || "";
            this.valordefeito = data.valordefeito || "";
            this.ordem = data.ordem || 0;
        }

        function MdashRendContainer(data) {

            this.mdashcontainerstamp = data.mdashcontainerstamp || generateUUID();
            this.codigo = data.codigo || "";
            this.titulo = data.titulo || "";
            this.tipo = data.tipo || "";
            this.tamanho = data.tamanho || 12;
            this.ordem = data.ordem || 0;
            this.dashboardstamp = data.dashboardstamp || GMDashStamp;
        }

        function MdashContainerItem(data) {


            var cardContainerItemData = {
                id: "",
                title: "Conteúdo não disponível",
                type: "primary",
                headerCustomData: "data-container-item='true'",
                bodyContent: ""
            }

            this.mdashcontaineritemstamp = data.mdashcontaineritemstamp || generateUUID();
            this.mdashcontainerstamp = data.mdashcontainerstamp || "";
            this.codigo = data.codigo || "";
            this.titulo = data.titulo || "";
            this.tipo = data.tipo || "";
            this.tamanho = data.tamanho || 4;
            this.ordem = data.ordem || 0;
            this.filters = data.filters || []
            this.urlfetch = data.urlfetch || "";
            this.layoutcontaineritemdefault = data.layoutcontaineritemdefault || true;
            this.expressaolayoutcontaineritem = data.expressaolayoutcontaineritem || "";
            this.dashboardstamp = data.dashboardstamp || "";
            this.fontelocal = data.fontelocal || false;
            this.renderedContent = data.renderedContent || generateStandardCard({ titulo: "Sem conteúdo disponível", bodyContent: "" }) || "";
            this.expressaoapresentacaodados = data.expressaoapresentacaodados || "";
        }

        MdashContainerItem.prototype.refreshContent = async function () {
            try {
                var containerItem = this;


                if (containerItem.filters.length == 0) {

                    containerItem.cleanAndRender(generateDashCardHTML({ title: containerItem.titulo, bodyContent: "<h3 class='m-dash-item-text' >Sem conteúdo</h3>" }));
                    return
                }

                if (!containerItem.urlfetch) {

                    containerItem.cleanAndRender(buildAlert("alert-danger", "URL para listagem  não definida"));
                    return;
                }

                var requestData = {
                    codigo: globalThis.dashboardconfig.codigo,
                    mdashcontaineritemstamp: containerItem.mdashcontaineritemstamp,
                    filters: globalThis.filterValues
                }

                var response = await $.ajax({
                    type: "POST",
                    url: containerItem.urlfetch,
                    data: {
                        '__EVENTARGUMENT': JSON.stringify([requestData]),
                    }
                });

                var errorMessage = "ao trazer resultados no [refreshContent] "

                if (response.cod != "0000") {

                    console.log("Erro " + errorMessage, response)

                    containerItem.cleanAndRender(buildAlert("alert-danger", "Erro ao trazer resultados: "));
                    return false
                }

                var contentRecords = response.data || [];

                containerItem.handleLayout();
                
                eval(containerItem.expressaoapresentacaodados);


            }
            catch (error) {
                console.log("Erro interno " + errorMessage, error)
                containerItem.cleanAndRender(buildAlert("alert-danger", "Erro interno ao processar resultados: "));


                //alertify.error("Erro interno " + errorMessage, 10000)
            }

        };

        MdashContainerItem.prototype.handleLayout = function (content) {
            var containerItem = this;
            if (containerItem.layoutcontaineritemdefault) {
                containerItem.cleanAndRender(generateDashCardHTML({ id: "m-dash-layout-" + containerItem.mdashcontaineritemstamp, title: containerItem.titulo, bodyContent: "" }));

            } else {

                if (containerItem.expressaolayoutcontaineritem) {
                    eval(containerItem.expressaolayoutcontaineritem);
                }
            }

        }

        MdashContainerItem.prototype.render = function (content) {

            $("#" + this.mdashcontaineritemstamp).append(content);
        }

        MdashContainerItem.prototype.cleanAndRender = function (content) {

            $("#" + this.mdashcontaineritemstamp).empty();
            $("#" + this.mdashcontaineritemstamp).append(content);
        }

        MdashContainerItem.prototype.renderOnLayout = function (content) {

            $("#m-dash-layout-" + this.mdashcontaineritemstamp).append(content);
        }

        MdashContainerItem.prototype.cleanAndRenderOnLayout = function (content) {

            $("#m-dash-layout-" + this.mdashcontaineritemstamp).empty();
            $("#m-dash-layout-" + this.mdashcontaineritemstamp).append(content);
        }


        MdashContainerItem.prototype.renderBodyLayout = function (content) {

            $("#m-dash-layout-" + this.mdashcontaineritemstamp + " .dashcard-body").append(content);
        }

        MdashContainerItem.prototype.cleanAndRenderBodyLayout = function (content) {

            $("#m-dash-layout-" + this.mdashcontaineritemstamp + " .dashcard-body").empty();
            $("#m-dash-layout-" + this.mdashcontaineritemstamp + " .dashcard-body").append(content);
        }
    }

    var GMainDashInstance = new Mdash({
        dashboardconfig: {
            dashboardstamp: "",
            codigo: "",
            descricao: "",
        },
        categoria: ""
    });



    function handleDefaultValue(dataType, valor) {
        switch (dataType.trim()) {
            case "digit":
                var inputValTxt = (String(valor) ? String(valor).replaceAll(" ", "").replaceAll(",", "") : "0")

                return inputValTxt;
                return isNaN(inputValTxt) || inputValTxt == null || inputValTxt == undefined || inputValTxt == "" ? 0 : inputValTxt;

            case "text":

                return valor ? valor : "";
            default:
                return valor;
        }
    }

    function getValorDefeito(filter) {

        var valorDefeito = null;
        if (filter.valordefeito) {
            valorDefeito = eval(filter.valordefeito);
        }

        var cachedFilters = window.localStorage.getItem("mdashcachedFilters");
        cachedFilters = cachedFilters ? JSON.parse(cachedFilters) : {};

        if (cachedFilters[filter.codigo]) {
            valorDefeito = cachedFilters[filter.codigo];
        }

        return handleDefaultValue(filter.tipo, valorDefeito);

    }




    var GConfigDash = null;
    $(document).ready(function () {

        var state = PetiteVue.reactive({
            mdash: GMainDashInstance,
            getOptions(filter) {
                try {
                    return eval(filter.expressaolistagem) || [];
                } catch (e) {
                    console.warn('Erro em expressaolistagem', e);
                    return [];
                }
            },
            getRowGroups(containerStamp) {
                // Filtra os items do container específico
                var containerItems = this.mdash.containerItems.filter(function (item) {
                    return item.mdashcontainerstamp === containerStamp;
                });

                // Ordena por ordem se necessário
                containerItems.sort(function (a, b) {
                    return (a.ordem || 0) - (b.ordem || 0);
                });

                // Agrupa em rows
                return groupItemsByRows(containerItems);
            },
            updateFilter(filtro, event) {

                var containerItemsThatContainFilter = []

                this.mdash.containerItems.map(function (item) {

                    var filterFound = item.filters.find(function (f) {
                        return f == filtro.codigo;
                    })


                    if (filterFound) {
                        containerItemsThatContainFilter.push(item);
                    }

                })

                containerItemsThatContainFilter.forEach(async function (itemWithFilter) {

                    await itemWithFilter.refreshContent();

                })

                this.mdash.filterValues[filtro.codigo] = event.target.value;
                window.localStorage.setItem("mdashcachedFilters", JSON.stringify(this.mdash.filterValues));

            }
        });




        window.mdashAppState = state;

        PetiteVue.createApp(state).mount("#mdash");

        handleMdashConfigData().then(function (data) {

            if (GConfigDash) {

                window.mdashAppState.mdash.containerItems.forEach(async function (item) {

                    try {
                        await item.refreshContent();

                    } catch (error) {

                    }
                })
            }

        })

    });

    async function handleMdashConfigData() {
        try {

            params = new URLSearchParams(document.location.search);
            codigomdash = params.get("codigomdash");

            if (!codigomdash) {
                $(".m-dash-main").empty();
                var alertResult = buildAlert("alert-danger", "O código do Dashboard não foi encontrado.");

                $(".m-dash-main").append(alertResult);
                return false;
            }

            var errorMessage = "ao trazer resultados da configuração do m dashboard ao rendereizar o m dashboard";
            var response = await $.ajax({
                type: "POST",
                url: "../programs/gensel.aspx?cscript=getconfiguracaoclientmdash",
                data: {
                    '__EVENTARGUMENT': JSON.stringify([{ codigo: codigomdash }]),
                }
            });


            if (response.cod != "0000") {
                console.log("Erro " + errorMessage, response);
                return false;
            }

            var configData = response.data

            var dashboardconfig = response.data.dashboard[0] || {};


            configData.dashboardconfig = dashboardconfig;

            var configData = new Mdash(configData);
            var filters = configData.filters || [];
            var filterValues = {};

            filters.forEach(function (filter) {
                filterValues[filter.codigo] = getValorDefeito(filter);
            });

            configData.filterValues = filterValues;

            window.localStorage.setItem("mdashcachedFilters", JSON.stringify(configData.filterValues));

            window.mdashAppState.mdash = configData;

            GConfigDash = configData;

            // console.log("configData", configData)

        } catch (error) {
            console.log("Erro interno " + errorMessage, error);
        }


    }


</script>



</html>